<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>EMRS by EllowDigital – Get Your E-Pass</title>
  <meta name="description"
    content="Event Management & Registration System (EMRS) by EllowDigital. Collect registrations, capture photos, and issue e-passes for any event in minutes." />
  <meta name="keywords"
    content="EMRS, EllowDigital, event management, event registration system, e-pass generator, digital pass, attendee check-in" />
  <meta name="author" content="EllowDigital" />
  <link rel="canonical" href="https://get-epass.netlify.app/" />

  <meta property="og:title" content="EMRS by EllowDigital – Get Your E-Pass" />
  <meta property="og:description"
    content="Manage registrations and download personalized e-passes for any event using EMRS by EllowDigital." />
  <meta property="og:image" content="https://get-epass.netlify.app/assets/unnamed.jpg" />
  <meta property="og:url" content="https://get-epass.netlify.app/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="EMRS by EllowDigital" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="EMRS by EllowDigital – Get Your E-Pass" />
  <meta name="twitter:description"
    content="Manage registrations and download personalized e-passes for any event using EMRS by EllowDigital." />
  <meta name="twitter:image" content="https://get-epass.netlify.app/assets/unnamed.jpg" />

  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="assets/favicon/favicon.ico" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="/manifest.json" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />

  <script>
    window.addEventListener("load", () => {
      const purgeCaches = () => {
        if ("caches" in window) {
          caches
            .keys()
            .then((keys) => Promise.all(keys.map((key) => caches.delete(key))))
            .catch(() => undefined);
        }
      };

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .getRegistrations()
          .then((registrations) =>
            Promise.all(
              registrations.map((registration) => registration.unregister()),
            ),
          )
          .then(purgeCaches)
          .catch((error) => {
            console.error("Service worker cleanup failed:", error);
            purgeCaches();
          });
      } else {
        purgeCaches();
      }
    });
  </script>

  <link rel="preload"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
    as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript>
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" />
  </noscript>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css" />

  <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "EMRS by EllowDigital",
        "url": "https://get-epass.netlify.app/",
        "description": "Event Management & Registration System for collecting registrations, issuing digital passes, and managing attendee check-ins.",
        "operatingSystem": "Web",
        "applicationCategory": "BusinessApplication",
        "publisher": {
          "@type": "Organization",
          "name": "EllowDigital",
          "url": "https://ellowdigital.netlify.app/"
        }
      }
  </script>

  <style>
    :root {
      --primary-color: #0d2c4f;
      --primary-dark: #0a2540;
      --accent-color: #fdb813;
      --accent-hover: #e4a60b;
      --text-color: #333;
      --text-light: #6c757d;
      --card-bg: #ffffff;
      --body-bg: #f4f7fa;
      --border-color: #dee2e6;
      --success-color: #198754;
      --danger-color: #dc3545;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: "Inter", sans-serif;
      color: var(--text-color);
      background-color: var(--body-bg);
      opacity: 0;
      animation: fadeIn 0.6s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .main-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .registration-wrapper {
      max-width: 1200px;
      width: 100%;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .info-panel {
      background-color: var(--primary-dark);
      color: #fff;
      padding: 3rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .info-panel .expo-title {
      font-family: "Playfair Display", serif;
      font-size: clamp(2rem, 5vw, 2.75rem);
      line-height: 1.2;
      margin-bottom: 1rem;
    }

    .info-panel .lead {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 2rem;
    }

    .event-detail-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.25rem;
    }

    .event-detail-item .icon {
      font-size: 1.5rem;
      width: 40px;
      color: var(--accent-color);
    }

    .form-panel {
      padding: 3rem 4rem;
    }

    @media (max-width: 991.98px) {
      .form-panel {
        padding: 2rem;
      }
    }

    .form-panel .form-heading {
      font-family: "Playfair Display", serif;
      color: var(--primary-dark);
      font-size: clamp(2rem, 5vw, 2.5rem);
    }

    .form-control,
    .form-check-input {
      border-radius: 8px;
      transition: all 0.2s ease-in-out;
    }

    .form-control:focus,
    .form-check-input:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 0.25rem rgba(253, 184, 19, 0.3);
      transform: scale(1.02);
    }

    .form-control:invalid {
      border-color: var(--danger-color);
    }

    .image-upload-wrapper {
      position: relative;
      width: 150px;
      height: 150px;
      margin: 0 auto 1.5rem auto;
    }

    #imagePreview {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid var(--border-color);
      background-color: #e9ecef;
      transition: all 0.3s ease;
    }

    #profileImage {
      display: none;
    }

    #uploadLabel {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 40px;
      height: 40px;
      background: var(--primary-dark);
      color: white;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease;
    }

    #uploadLabel:hover {
      transform: scale(1.1);
    }

    .day-selector .form-check {
      padding-left: 0;
    }

    .day-selector .form-check-input {
      display: none;
    }

    .day-selector .form-check-label {
      display: block;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      text-align: center;
      font-weight: 500;
    }

    .day-selector .form-check-input:checked+.form-check-label {
      background-color: var(--primary-dark);
      color: white;
      border-color: var(--primary-dark);
      box-shadow: 0 5px 15px rgba(10, 37, 64, 0.2);
      transform: translateY(-2px);
    }

    .btn-submit {
      background: var(--accent-color);
      border: none;
      color: var(--primary-dark);
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background: var(--accent-hover);
      color: var(--primary-dark);
      box-shadow: 0 7px 20px rgba(228, 166, 11, 0.3);
      transform: translateY(-3px);
    }

    /* Upload progress */
    .upload-progress {
      height: 14px;
      background: linear-gradient(90deg,
          rgba(13, 44, 79, 0.08),
          rgba(13, 44, 79, 0.06));
      border-radius: 10px;
      overflow: hidden;
      margin-top: 0.75rem;
      display: none;
    }

    .upload-progress .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-color), #e8b53b);
      transition: width 200ms linear;
    }

    .upload-progress .label {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-light);
      text-align: center;
    }

    .success-view {
      text-align: center;
      padding: 2rem 0;
    }

    #download-id-btn {
      background: var(--success-color);
      color: white;
    }

    #id-card-template {
      display: none;
    }

    .id-card {
      width: 380px;
      font-family: "Inter", sans-serif;
      background-color: #f4f7fa;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      text-align: center;
      border: 1px solid #e0e0e0;
    }

    .id-card-header {
      background: var(--primary-dark);
      padding: 1.75rem 1.25rem 78px;
      text-align: center;
    }

    .id-card-header .expo-title {
      font-family: "Playfair Display", serif;
      font-size: 2.1rem;
      font-weight: 700;
      color: #ffffff;
      letter-spacing: 0.5px;
    }

    .id-card-header .pass-subtitle {
      font-size: 0.95rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.85);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-top: 0.35rem;
    }

    .id-card-body {
      position: relative;
      padding: 1rem 1.5rem 1.5rem 1.5rem;
      background-color: transparent;
    }

    .id-card-photo-wrapper {
      margin-top: -65px;
      position: relative;
      z-index: 10;
    }

    .id-card-photo {
      width: 130px;
      height: 130px;
      object-fit: cover;
      border-radius: 50%;
      border: 6px solid #ffffff;
      background: var(--card-bg);
      box-shadow:
        0 10px 25px rgba(0, 0, 0, 0.15),
        0 0 0 6px rgba(13, 44, 79, 0.12);
    }

    .id-card-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-top: 1rem;
      margin-bottom: 0.25rem;
      line-height: 1.2;
    }

    .id-card-qr-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      background: rgba(10, 37, 64, 0.04);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1.5rem;
    }

    .id-card-qr {
      width: 120px;
      height: 120px;
      display: grid;
      place-items: center;
      padding: 0.35rem;
      background: #ffffff;
      border-radius: 14px;
      border: 2px solid rgba(13, 44, 79, 0.18);
      overflow: visible;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
    }

    .id-card-qr canvas,
    .id-card-qr img {
      width: 100% !important;
      height: 100% !important;
    }

    .id-card-qr-details {
      text-align: left;
    }

    .id-card-qr-details .label {
      font-size: 0.75rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 0.25rem;
      display: block;
    }

    .id-card-qr-details .value {
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 1rem;
    }

    .id-card-qr-details .secondary-label {
      margin-top: 0.6rem;
      font-size: 0.7rem;
      opacity: 0.75;
    }

    .id-card-footer {
      background-color: var(--primary-dark);
      padding: 0.85rem 1.25rem;
      color: rgba(255, 255, 255, 0.85);
      font-size: 0.9rem;
      letter-spacing: 0.4px;
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }

    .lost-pass-link {
      transition:
        color 0.3s ease,
        transform 0.2s ease;
    }

    .lost-pass-link:hover {
      color: #0d6efd;
      transform: scale(1.05);
      text-decoration: underline;
    }

    .footer-custom {
      background-color: var(--primary-dark);
      color: white;
    }

    .blinking-heart {
      color: red;
      animation: blink 1s infinite;
      font-size: 1.2em;
      margin-left: 5px;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <div class="registration-wrapper">
      <div class="row g-0">
        <div class="col-lg-5 info-panel">
          <div>
            <h1 class="expo-title">Event Management & Registration System</h1>
            <p class="lead">
              EMRS by <strong>EllowDigital</strong> helps you spin up branded
              registration flows for any event. Collect attendee details,
              capture profile photos, and issue secure e-passes ready for
              check-in teams.
            </p>

            <p class="text-white-50 mb-4">
              Reuse this tool for conferences, meetups, exhibitions, or any
              gathering that needs structured registration and instant digital
              passes.
            </p>

            <hr class="my-4" style="opacity: 0.3" />
            <div class="event-details-list">
              <div class="event-detail-item">
                <i class="fa-solid fa-clipboard-list icon"></i>
                <div>
                  <h5 class="fw-bold mb-0">Step 1</h5>
                  <p class="mb-0">
                    Capture attendee essentials (name, phone, location)
                  </p>
                </div>
              </div>
              <div class="event-detail-item">
                <i class="fa-solid fa-camera icon"></i>
                <div>
                  <h5 class="fw-bold mb-0">Step 2</h5>
                  <p class="mb-0">Attach a compliant profile photograph</p>
                </div>
              </div>
              <div class="event-detail-item">
                <i class="fa-solid fa-download icon"></i>
                <div>
                  <h5 class="fw-bold mb-0">Step 3</h5>
                  <p class="mb-0">
                    Generate and download event-ready e-passes
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-7 form-panel">
          <div id="success-view" class="d-none success-view" aria-live="polite">
            <h2 class="form-heading mb-3">Registration Confirmed!</h2>
            <p class="lead mb-4 text-secondary">
              Your e-pass is ready. Please download and save it for entry.
            </p>
            <div id="id-card-wrapper" class="d-flex justify-content-center mb-4"></div>
            <div class="d-grid">
              <button id="download-id-btn" class="btn btn-submit">
                <i class="fas fa-download me-2"></i>Download E-Pass
              </button>
            </div>
          </div>

          <div id="form-container">
            <div class="alert alert-info rounded-3 text-start mb-4" role="alert">
              Misplaced your pass? Submit the form again with the same phone
              number or use the lookup link below to instantly retrieve your
              existing e-pass.
            </div>

            <h2 class="form-heading mb-1">Get Your E-Pass</h2>
            <p class="mb-4 text-muted">
              Share your details, upload a photo, and download your pass in a
              few seconds.
            </p>
            <form id="registrationForm" novalidate>
              <div class="image-upload-wrapper">
                <img id="imagePreview" src="https://placehold.co/150x150/e9ecef/6c757d?text=Upload+Photo"
                  alt="Profile image preview" />
                <input type="file" id="profileImage" name="profileImage" accept="image/png, image/jpeg, image/jpg"
                  required />
                <label for="profileImage" id="uploadLabel" title="Upload Photo"><i
                    class="fa-solid fa-camera"></i></label>
              </div>
              <p class="text-muted small text-center mt-2" id="imageMeta">
                Upload a recent photo (up to 10MB). We will compress it for
                you.
              </p>

              <div class="row g-3">
                <div class="col-md-6">
                  <label for="name" class="form-label fw-semibold">Full Name</label>
                  <input type="text" class="form-control" id="name" name="name" required minlength="3" />
                </div>
                <div class="col-md-6">
                  <label for="phone" class="form-label fw-semibold">10-Digit Phone</label>
                  <input type="tel" class="form-control" id="phone" name="phone" required pattern="^[6-9]\d{9}$"
                    placeholder="e.g., 9876543210" />
                </div>
                <div class="col-md-6">
                  <label for="email" class="form-label fw-semibold">Email Address</label>
                  <input type="email" class="form-control" id="email" name="email" required
                    placeholder="e.g., user@example.com" autocomplete="email" />
                </div>
                <div class="col-md-6">
                  <label for="district" class="form-label fw-semibold">City / District</label>
                  <input type="text" class="form-control" id="district" name="district" required />
                </div>
                <div class="col-md-6">
                  <label for="state" class="form-label fw-semibold">State</label>
                  <input type="text" class="form-control" id="state" name="state" required />
                </div>
                <div class="col-12 mt-4 d-grid">
                  <button class="btn btn-submit" type="submit" id="submitBtn">
                    <span class="button-text">Register & Get Pass</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                  </button>
                  <div class="upload-progress" id="uploadProgress">
                    <div class="bar" id="uploadProgressBar"></div>
                    <div class="label" id="uploadProgressLabel">
                      Preparing upload...
                    </div>
                  </div>
                </div>
              </div>
            </form>
            <div class="text-center mt-3">
              <small class="text-muted d-block mb-1">Already registered but lost your pass?</small>
              <a href="#" id="lostPassLink" role="button" aria-label="Find lost e-pass"
                class="btn btn-outline-primary mt-2">
                <i class="bi bi-search me-1"></i>Find your lost e-pass
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0" style="border-radius: 16px">
        <div class="modal-header text-white" id="infoModalHeader">
          <h5 class="modal-title fw-bold" id="infoModalTitle"></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4" id="infoModalBody" aria-live="polite"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="alreadyRegisteredModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0" style="border-radius: 16px">
        <div class="modal-body text-center p-4">
          <i class="fa-solid fa-user-check fa-4x mb-3" style="color: var(--primary-color)"></i>
          <h5 class="modal-title mb-2 fw-bold" id="modalLabel">
            We Found Your E-Pass!
          </h5>
          <p class="text-muted">
            Welcome back, <strong id="registeredUserName"></strong>! We
            located an existing e-pass linked to this phone number.
          </p>
          <div class="d-grid gap-2 mt-4">
            <button type="button" class="btn btn-submit" id="modalDownloadBtn">
              <i class="fas fa-download me-2"></i>Download Your E-Pass
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="lostPassModal" tabindex="-1" aria-labelledby="lostPassModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0" style="border-radius: 16px">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="lostPassModalLabel">
            Find Your E-Pass
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <p class="text-muted">
            Enter the 10-digit phone number you used to register.
          </p>
          <form id="lostPassForm">
            <div class="mb-3">
              <label for="lostPhoneInput" class="form-label fw-semibold">Phone Number</label>
              <input type="tel" class="form-control" id="lostPhoneInput" required pattern="^[6-9]\d{9}$" />
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary" id="findPassBtn">
                <span class="button-text">Find My Pass</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>
          <div id="lostPassError" class="alert alert-danger mt-3 d-none" role="alert"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="id-card-template">
    <div class="id-card">
      <div class="id-card-header">
        <div class="expo-title">EMRS E-Pass</div>
        <div class="pass-subtitle">Official Entry Credential</div>
      </div>
      <div class="id-card-body">
        <div class="id-card-photo-wrapper">
          <img class="id-card-photo" src="" alt="Attendee Photo" crossorigin="anonymous" />
        </div>
        <h3 class="id-card-name"></h3>
        <div class="id-card-qr-wrapper">
          <div class="id-card-qr" aria-label="QR code for e-pass"></div>
          <div class="id-card-qr-details">
            <span class="label">Pass ID</span>
            <span class="value id-card-reg-number-short"></span>
            <span class="label secondary-label">Scan for verification</span>
          </div>
        </div>
      </div>
      <div class="id-card-footer">
        <i class="fa-solid fa-shield-check me-1"></i> Keep this pass handy for
        verification
      </div>
    </div>
  </div>

  <footer class="footer-custom text-center py-4">
    <div class="container">
      <p class="mb-0">© 2025 E-Pass Portal. All rights reserved.</p>
      <p class="mb-0">
        Made with love by
        <a href="https://ellowdigital.netlify.app" target="_blank" rel="noopener noreferrer"
          class="text-white text-decoration-underline">
          EllowDigital
        </a>
      </p>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // --- Configuration & Constants ---
      const API_ENDPOINT = "/.netlify/functions/submit-registration";
      const FIND_PASS_ENDPOINT = "/.netlify/functions/find-pass";

      // --- DOM Elements ---
      const form = document.getElementById("registrationForm");
      const submitBtn = document.getElementById("submitBtn");
      const formContainer = document.getElementById("form-container");
      const successView = document.getElementById("success-view");
      const idCardWrapper = document.getElementById("id-card-wrapper");
      const downloadBtn = document.getElementById("download-id-btn");
      const profileImageInput = document.getElementById("profileImage");
      const imagePreview = document.getElementById("imagePreview");
      const lostPassLink = document.getElementById("lostPassLink");
      const lostPassModalEl = document.getElementById("lostPassModal");
      const lostPassModal = new bootstrap.Modal(lostPassModalEl);
      const lostPassForm = document.getElementById("lostPassForm");
      const findPassBtn = document.getElementById("findPassBtn");
      const lostPhoneInput = document.getElementById("lostPhoneInput");
      const lostPassError = document.getElementById("lostPassError");

      // Modal elements
      const infoModalEl = document.getElementById("infoModal");
      const infoModal = new bootstrap.Modal(infoModalEl);
      const registeredModalEl = document.getElementById(
        "alreadyRegisteredModal",
      );
      const registeredModal = new bootstrap.Modal(registeredModalEl);
      const modalUserName = document.getElementById("registeredUserName");
      const modalDownloadBtn = document.getElementById("modalDownloadBtn");

      // --- State ---
      let compressedImageFile = null;
      let lastSelectedImageFile = null;
      let existingUserData = null;
      let previewObjectUrl = null;
      const defaultPhotoUrl = imagePreview.getAttribute("src");
      const MAX_ORIGINAL_FILE_MB = 10;
      const MAX_COMPRESSED_KB = 30;
      const DESIRED_COMPRESSED_KB = 20;
      const WIDTH_STEPS = [
        720, 600, 480, 360, 300, 240, 200, 180, 160, 140, 120, 100, 90, 80,
      ];
      const QUALITY_STEPS = [
        0.7, 0.6, 0.5, 0.45, 0.4, 0.35, 0.3, 0.25, 0.2, 0.18, 0.16, 0.14,
        0.12, 0.1,
      ];

      const formatFileSize = (bytes) => {
        if (!bytes && bytes !== 0) return "0 KB";
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / 1024 / 1024).toFixed(2)} MB`;
      };

      const updateImageMeta = (originalFile, compressedFile, note = "") => {
        const metaEl = document.getElementById("imageMeta");
        if (!metaEl) return;
        if (!originalFile) {
          metaEl.textContent =
            "Upload a recent photo (up to 10MB). We will compress it for you.";
          return;
        }
        const originalText = formatFileSize(originalFile.size);
        const compressedText = formatFileSize(
          (compressedFile || originalFile).size,
        );
        metaEl.textContent = `Original: ${originalText} → Compressed: ${compressedText}${note ? ` • ${note}` : ""}`;
      };

      const compressImageOnClient = async (file) => {
        let bestWithinLimit = null;
        let smallestAttempt = file;

        for (const width of WIDTH_STEPS) {
          for (const quality of QUALITY_STEPS) {
            try {
              const compressed = await imageCompression(file, {
                maxWidthOrHeight: width,
                useWebWorker: true,
                initialQuality: quality,
                maxSizeMB: MAX_COMPRESSED_KB / 1024,
                fileType: "image/jpeg",
              });

              if (compressed.size < smallestAttempt.size) {
                smallestAttempt = compressed;
              }

              if (compressed.size <= DESIRED_COMPRESSED_KB * 1024) {
                return compressed;
              }

              if (compressed.size <= MAX_COMPRESSED_KB * 1024) {
                if (
                  !bestWithinLimit ||
                  compressed.size < bestWithinLimit.size
                ) {
                  bestWithinLimit = compressed;
                }
              }
            } catch (error) {
              console.warn(
                `Compression attempt failed at width ${width} quality ${quality}:`,
                error,
              );
            }
          }
        }

        if (bestWithinLimit) {
          return bestWithinLimit;
        }

        if (
          smallestAttempt &&
          smallestAttempt.size <= MAX_COMPRESSED_KB * 1024
        ) {
          return smallestAttempt;
        }

        return null;
      };

      const normalizeRegistrationData = (raw) => {
        if (!raw) return null;
        return {
          registrationId: raw.registrationId || raw.registration_id || "",
          name: raw.name || "",
          phone: raw.phone || "",
          email: raw.email || "",
          city: raw.city || "",
          state: raw.state || "",
          profileImageUrl:
            raw.profileImageUrl || raw.image_url || defaultPhotoUrl,
        };
      };

      // --- UI & UX Functions ---
      function setButtonLoading(button, isLoading) {
        const buttonText = button.querySelector(".button-text");
        const spinner = button.querySelector(".spinner-border");
        if (!buttonText || !spinner) return;

        button.disabled = isLoading;
        buttonText.classList.toggle("d-none", isLoading);
        spinner.classList.toggle("d-none", !isLoading);
      }

      function showInfoModal(title, content, type = "error") {
        const modalHeader = infoModalEl.querySelector("#infoModalHeader");
        const modalTitle = infoModalEl.querySelector("#infoModalTitle");
        const modalBody = infoModalEl.querySelector("#infoModalBody");

        const typeConfig = {
          error: { bg: "bg-danger", icon: "fa-solid fa-circle-xmark" },
          success: { bg: "bg-success", icon: "fa-solid fa-circle-check" },
          info: { bg: "bg-primary", icon: "fa-solid fa-circle-info" },
        };
        const config = typeConfig[type] || typeConfig.error;

        modalHeader.className = `modal-header text-white ${config.bg}`;
        modalTitle.innerHTML = `<i class="${config.icon} me-2"></i> ${title}`;

        modalBody.innerHTML = "";
        if (typeof content === "string") {
          modalBody.innerHTML = content;
        } else {
          modalBody.appendChild(content);
        }
        infoModal.show();
      }

      async function generateAndDownloadPass(rawData) {
        const userData = normalizeRegistrationData(rawData);
        if (!userData) {
          showInfoModal(
            "Download Failed",
            "We could not load your pass details. Please try again.",
          );
          return;
        }
        const passElement = createPassElement(userData);
        document.body.appendChild(passElement);

        try {
          const canvas = await html2canvas(passElement, {
            scale: 3,
            useCORS: true,
            backgroundColor: null,
          });
          const link = document.createElement("a");
          const name = userData.name.trim().replace(/\s+/g, "_");
          link.download = `E-Pass_${name}_${userData.registrationId}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();
        } catch (err) {
          console.error("Download Error:", err);
          showInfoModal(
            "Download Failed",
            "Could not generate the pass image. Please try taking a screenshot instead.",
            "error",
          );
        } finally {
          document.body.removeChild(passElement);
        }
      }

      // --- E-Pass Generation ---
      function createPassElement(rawData) {
        const data = normalizeRegistrationData(rawData);
        if (!data) {
          throw new Error("Invalid registration data.");
        }
        const template = document
          .getElementById("id-card-template")
          .cloneNode(true);
        const card = template.firstElementChild;
        card.style.display = "block";

        const photoEl = card.querySelector(".id-card-photo");
        if (photoEl) {
          photoEl.src = data.profileImageUrl || defaultPhotoUrl;
          photoEl.alt = `${data.name || "Guest"} profile photo`;
        }

        const nameEl = card.querySelector(".id-card-name");
        if (nameEl) {
          nameEl.textContent = data.name || "Guest";
        }

        const regShortEl = card.querySelector(".id-card-reg-number-short");
        if (regShortEl) {
          regShortEl.textContent = data.registrationId;
        }

        const fullRegEl = card.querySelector(".id-card-reg-number");
        if (fullRegEl) {
          fullRegEl.textContent = data.registrationId;
        }

        const qrContainer = card.querySelector(".id-card-qr");
        if (qrContainer) {
          qrContainer.innerHTML = "";
          const qrPayload = JSON.stringify({
            registrationId: data.registrationId,
            phone: data.phone,
          });
          try {
            if (typeof QRCode !== "undefined") {
              new QRCode(qrContainer, {
                text: qrPayload,
                width: 120,
                height: 120,
                colorDark: "#0A2540",
                colorLight: "#FFFFFF",
                correctLevel: QRCode.CorrectLevel.M,
              });
            } else {
              qrContainer.textContent = "QR unavailable";
            }
          } catch (qrError) {
            console.error("QR generation failed:", qrError);
            qrContainer.textContent = "QR unavailable";
          }
        }

        return card;
      }

      // --- Form & Input Handling ---
      profileImageInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) {
          updateImageMeta(null, null);
          return;
        }

        lastSelectedImageFile = file;

        const originalSizeMB = file.size / 1024 / 1024;
        if (originalSizeMB > MAX_ORIGINAL_FILE_MB) {
          showInfoModal(
            "File Too Large",
            `Image is too large (${originalSizeMB.toFixed(2)}MB). Please select a file smaller than ${MAX_ORIGINAL_FILE_MB}MB.`,
            "error",
          );
          profileImageInput.value = "";
          lastSelectedImageFile = null;
          updateImageMeta(null, null);
          return;
        }

        updateImageMeta(file, file, "Compressing...");

        try {
          const compressedCandidate = await compressImageOnClient(file);
          if (!compressedCandidate) {
            throw new Error("Could not compress the image below 30KB.");
          }
          compressedImageFile = compressedCandidate;
        } catch (error) {
          console.error("Image compression error:", error);
          showInfoModal(
            "Compression Failed",
            "We couldn't shrink this photo below 30KB. Please choose a different picture (passport style works best).",
            "error",
          );
          profileImageInput.value = "";
          lastSelectedImageFile = null;
          compressedImageFile = null;
          if (previewObjectUrl) {
            URL.revokeObjectURL(previewObjectUrl);
            previewObjectUrl = null;
          }
          imagePreview.src = defaultPhotoUrl;
          updateImageMeta(null, null);
          return;
        }

        if (compressedImageFile.size > MAX_COMPRESSED_KB * 1024) {
          showInfoModal(
            "Image Still Too Large",
            `We compressed your photo to ${formatFileSize(compressedImageFile.size)}, but it must be under ${MAX_COMPRESSED_KB}KB. Please select a smaller image.`,
            "error",
          );
          profileImageInput.value = "";
          lastSelectedImageFile = null;
          compressedImageFile = null;
          if (previewObjectUrl) {
            URL.revokeObjectURL(previewObjectUrl);
            previewObjectUrl = null;
          }
          imagePreview.src = defaultPhotoUrl;
          updateImageMeta(null, null);
          return;
        }

        if (previewObjectUrl) {
          URL.revokeObjectURL(previewObjectUrl);
        }
        previewObjectUrl = URL.createObjectURL(compressedImageFile);
        imagePreview.src = previewObjectUrl;
        updateImageMeta(
          file,
          compressedImageFile,
          compressedImageFile.size <= DESIRED_COMPRESSED_KB * 1024
            ? "Optimized (~20KB)"
            : "Optimized",
        );

        if (compressedImageFile.size > DESIRED_COMPRESSED_KB * 1024) {
          showInfoModal(
            "Image Optimized",
            `Your photo is ${formatFileSize(compressedImageFile.size)}. That's slightly above the ideal ${DESIRED_COMPRESSED_KB}KB target but still within the limit.`,
            "info",
          );
        }
      });

      function validateForm() {
        form
          .querySelectorAll(".is-invalid")
          .forEach((el) => el.classList.remove("is-invalid"));

        const errors = [];
        const addError = (field, message) => {
          errors.push({ field, message });
          if (field) field.classList.add("is-invalid");
        };

        if (profileImageInput.files.length === 0)
          errors.push({
            field: null,
            message: "A profile photo is required.",
          });
        if (!form.elements.name.checkValidity())
          addError(
            form.elements.name,
            "Please enter a valid full name (min. 3 characters).",
          );
        if (!form.elements.phone.checkValidity())
          addError(
            form.elements.phone,
            "Please enter a valid 10-digit Indian phone number.",
          );
        if (!form.elements.email.checkValidity())
          addError(
            form.elements.email,
            "Please enter a valid email address.",
          );
        if (!form.elements.district.checkValidity())
          addError(form.elements.district, "Please enter your district.");
        if (!form.elements.state.checkValidity())
          addError(form.elements.state, "Please enter your state.");

        if (errors.length > 0) {
          const errorList = document.createElement("ul");
          errorList.className = "list-unstyled text-start mb-0 ps-2";
          errors.forEach((err) => {
            const li = document.createElement("li");
            li.innerHTML = `<i class="fa-solid fa-times-circle text-danger me-2"></i>${err.message}`;
            errorList.appendChild(li);
          });
          showInfoModal("Please Complete the Form", errorList, "error");
          infoModalEl.addEventListener(
            "hidden.bs.modal",
            () => {
              const firstInvalidField = errors.find((e) => e.field);
              if (firstInvalidField) firstInvalidField.field.focus();
            },
            { once: true },
          );
          return false;
        }
        return true;
      }

      // --- Main Form Submission Logic with Improved Error Handling ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validateForm()) return;

        const formData = new FormData(form);
        const originalFile =
          lastSelectedImageFile || profileImageInput.files[0];
        const uploadSource = compressedImageFile || originalFile;
        if (uploadSource) {
          const uploadType = uploadSource.type || "image/jpeg";
          const baseName = originalFile?.name
            ? originalFile.name.replace(/\.[^.]+$/, "")
            : "profile-photo";
          let extension = ".jpg";
          if (uploadType.includes("png")) extension = ".png";
          else if (uploadType.includes("webp")) extension = ".webp";
          const finalName =
            uploadSource === originalFile && originalFile?.name
              ? originalFile.name
              : `${baseName}${extension}`;
          const finalFile =
            uploadSource instanceof File
              ? new File([uploadSource], finalName, { type: uploadType })
              : new File([uploadSource], finalName, { type: uploadType });
          formData.set("profileImage", finalFile, finalFile.name);
          updateImageMeta(originalFile, finalFile, "Ready to upload");
        }

        // XHR helper which reports upload progress
        function xhrPostWithProgress(url, data, onProgress, timeoutMs = 0) {
          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            if (timeoutMs > 0) xhr.timeout = timeoutMs;
            xhr.onload = function () {
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  resolve(JSON.parse(xhr.responseText || "{}"));
                } catch (e) {
                  resolve({});
                }
              } else {
                let parsed = {};
                try {
                  parsed = JSON.parse(xhr.responseText || "{}");
                } catch (e) { }
                const err = new Error(parsed.error || `HTTP ${xhr.status}`);
                err.status = xhr.status;
                err.body = parsed;
                reject(err);
              }
            };
            xhr.onerror = function () {
              reject(new Error("Network error during upload."));
            };
            xhr.ontimeout = function () {
              reject(new Error("Upload timed out."));
            };
            if (xhr.upload && typeof onProgress === "function") {
              xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                  onProgress(
                    (event.loaded / event.total) * 100,
                    event.loaded,
                    event.total,
                  );
                } else {
                  onProgress(null, event.loaded, null);
                }
              };
            }
            xhr.send(data);
          });
        }

        // Retry wrapper with exponential backoff
        async function postWithRetries(url, entries, maxRetries = 3) {
          let attempt = 0;
          let lastErr = null;
          const progressEl = document.getElementById("uploadProgress");
          const bar = document.getElementById("uploadProgressBar");
          const label = document.getElementById("uploadProgressLabel");
          if (progressEl) progressEl.style.display = "block";
          if (bar) bar.style.width = "2%";
          if (label) label.textContent = "Preparing upload...";

          while (attempt < maxRetries) {
            try {
              const data = new FormData();
              entries.forEach(([key, value]) => {
                data.append(key, value);
              });
              const res = await xhrPostWithProgress(
                url,
                data,
                (pct) => {
                  if (bar && pct !== null)
                    bar.style.width = `${Math.round(pct)}%`;
                  if (label && pct !== null)
                    label.textContent = `Uploading... ${Math.round(pct)}%`;
                  if (label && pct === null)
                    label.textContent = `Uploading...`;
                },
                180000,
              );
              if (bar) bar.style.width = "100%";
              if (label) label.textContent = "Finalizing...";
              return res;
            } catch (err) {
              lastErr = err;
              attempt += 1;
              const backoff = 1000 * 2 ** (attempt - 1);
              if (label)
                label.textContent = `Upload failed. Retrying in ${backoff / 1000}s...`;
              await new Promise((r) => setTimeout(r, backoff));
            }
          }
          throw lastErr;
        }

        // Kick off upload with UX improvements
        setButtonLoading(submitBtn, true);
        try {
          if (!navigator.onLine) throw new Error("You appear to be offline.");
          const formEntries = Array.from(formData.entries());
          const result = await postWithRetries(API_ENDPOINT, formEntries, 3);

          // Success handling
          if (result && result.status === "exists") {
            existingUserData = normalizeRegistrationData(
              result.registrationData,
            );
            modalUserName.textContent = existingUserData.name || "Guest";
            registeredModal.show();
          } else if (result && result.status === "success") {
            const registrationData = normalizeRegistrationData(
              result.registrationData,
            );
            existingUserData = registrationData;
            const newPassElement = createPassElement(registrationData);
            idCardWrapper.innerHTML = "";
            idCardWrapper.appendChild(newPassElement);
            formContainer.classList.add("d-none");
            successView.classList.remove("d-none");
            document.querySelector(".registration-wrapper").scrollIntoView();
            downloadBtn.onclick = () =>
              generateAndDownloadPass(existingUserData);
          } else {
            const serverMessage =
              (result && (result.error || result.details)) ||
              "Unexpected server response.";
            throw new Error(serverMessage);
          }
        } catch (error) {
          console.error("Submission Error:", error);
          let title = "Registration Failed";
          let message = "";
          if (error.message && error.message.includes("offline")) {
            title = "Connection Error";
            message =
              "<p>You seem to be offline. Please check your internet connection and try again.</p>";
          } else if (
            error.status >= 500 ||
            /timed out|Upload timed out|Network error/.test(error.message)
          ) {
            title = "Network / Server Error";
            message = `<p>We had trouble uploading your image or saving your registration. The upload may be slow — please try again. (${error.message})</p>`;
          } else {
            message = `<p>We couldn't complete your registration: <strong>${error.message}</strong></p><p>Please review the form or contact support if the problem persists.</p>`;
          }
          showInfoModal(title, message, "error");
        } finally {
          // hide progress after a short delay
          setTimeout(() => {
            const progressEl = document.getElementById("uploadProgress");
            const bar = document.getElementById("uploadProgressBar");
            const label = document.getElementById("uploadProgressLabel");
            if (progressEl) progressEl.style.display = "none";
            if (bar) bar.style.width = "0%";
            if (label) label.textContent = "";
          }, 600);
          setButtonLoading(submitBtn, false);
        }
      });

      modalDownloadBtn.addEventListener("click", () => {
        if (existingUserData) {
          generateAndDownloadPass(existingUserData);
        }
      });

      // --- NEW: Lost Pass Logic ---
      lostPassLink.addEventListener("click", (e) => {
        e.preventDefault();
        lostPassModal.show();
      });

      lostPassForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        setButtonLoading(findPassBtn, true);
        lostPassError.classList.add("d-none");

        const phone = lostPhoneInput.value.trim();
        if (!/^[6-9]\d{9}$/.test(phone)) {
          lostPassError.textContent =
            "Please enter a valid 10-digit phone number.";
          lostPassError.classList.remove("d-none");
          setButtonLoading(findPassBtn, false);
          return;
        }

        try {
          const response = await fetch(
            `${FIND_PASS_ENDPOINT}?phone=${phone}`,
          );
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Could not find registration.");
          }

          const normalized = normalizeRegistrationData(result);
          existingUserData = normalized;
          modalUserName.textContent = normalized?.name || "Guest";
          lostPassModal.hide();
          registeredModal.show();
        } catch (err) {
          lostPassError.textContent = err.message;
          lostPassError.classList.remove("d-none");
        } finally {
          setButtonLoading(findPassBtn, false);
        }
      });
      // Hide the info alert after a few seconds
      setTimeout(() => {
        const alertEl = document.querySelector(".alert.alert-info");
        if (alertEl) alertEl.style.display = "none";
      }, 8000);
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/service-worker.js")
          .catch((err) =>
            console.warn("Service worker registration failed", err),
          );
      });
    }
  </script>
</body>

</html>