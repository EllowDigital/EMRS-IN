<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>E-Pass Verify</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
        <style>
            body { background: #f7f9fc; }
            .scanner-card { max-width: 740px; margin: 36px auto; }
            #video { width:100%; height:auto; border-radius: 8px; display:block; }
            #videoPlaceholder { width:100%; height:320px; background:#e9ecef; display:flex; align-items:center; justify-content:center; border-radius:8px; color:#6c757d; }
            #scannerOverlay { position:absolute; inset:0; pointer-events:none; }
            .scanner-box { width:68%; max-width:420px; height:180px; margin:0 auto; border:3px dashed rgba(255,255,255,0.8); box-shadow:0 6px 18px rgba(0,0,0,0.08); border-radius:12px; }
            .scan-success { animation: flash 0.6s ease; }
            @keyframes flash { 0%{ box-shadow:0 0 0 0 rgba(16,185,129,0.0)} 50%{ box-shadow:0 0 0 10px rgba(16,185,129,0.12)} 100%{ box-shadow:0 0 0 0 rgba(16,185,129,0)} }
            .result-avatar { width:120px; height:120px; object-fit:cover; border-radius:999px; border:4px solid #fff; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-dark bg-primary py-2">
            <div class="container-fluid justify-content-center">
                <span class="navbar-brand mb-0 h4 text-white">E-Pass Check-In</span>
            </div>
        </nav>

        <main class="container">
            <div class="card scanner-card shadow-sm">
                <div class="card-body">
                    <div id="scanner-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>Scan QR</strong>
                                <div class="text-muted small">Camera will start automatically. Or use manual lookup.</div>
                            </div>
                            <div>
                                <button id="switch-to-manual" class="btn btn-outline-secondary btn-sm">Manual lookup</button>
                            </div>
                        </div>

                        <div style="position:relative;">
                            <video id="video" class="d-none" playsinline muted></video>
                            <div id="videoPlaceholder"><div class="text-center"><i class="bi bi-camera-video" style="font-size:36px"></i><div class="small mt-2">Camera preview</div></div></div>
                            <div id="scannerOverlay" class="d-none" aria-hidden="true">
                                <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
                                    <div id="scannerBox" class="scanner-box"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <div id="feedback" class="text-muted small">Ready</div>
                            <div id="cameraStatus" class="badge bg-secondary">Camera: Off</div>
                        </div>
                    </div>

                    <!-- manual lookup -->
                    <form id="manual-lookup-form" class="d-none mt-3">
                        <div class="input-group">
                            <input id="reg-id-input" class="form-control" placeholder="Enter Registration ID (eg UP25-...)" />
                            <button id="lookup-btn" class="btn btn-primary" type="submit">Lookup</button>
                        </div>
                        <div id="lookup-spinner" class="spinner-border spinner-border-sm text-primary mt-2 d-none" role="status"><span class="visually-hidden">Loading</span></div>
                    </form>

                    <!-- results -->
                    <div id="results-section" class="d-none mt-4 text-center">
                        <span id="result-status-badge" class="d-inline-block mb-3">
                            <span id="result-status-badge-text" class="badge bg-success">VERIFIED</span>
                        </span>

                        <div class="d-flex flex-column align-items-center gap-2">
                            <img id="result-avatar" class="result-avatar" src="https://placehold.co/150x150/6c757d/white?text=No+Photo" alt="avatar" />
                            <h5 id="result-name" class="mb-0">Name</h5>
                            <div id="result-reg-id" class="text-danger fw-bold">REG-0000</div>
                            <div id="result-phone" class="text-muted small">Phone</div>
                            <div id="result-email" class="text-muted small">Email</div>

                            <div class="mt-3 w-100">
                                <button id="checkin-btn" class="btn btn-success btn-lg w-100">Confirm Check-In <span id="checkin-spinner" class="spinner-border spinner-border-sm text-light ms-2 d-none" role="status"></span></button>
                                <button id="clear-btn-bottom" class="btn btn-outline-secondary btn-sm mt-2 w-100">Clear / Next</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
        <script>
            // Client scanner & check-in logic
            const video = document.getElementById('video');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const scannerOverlay = document.getElementById('scannerOverlay');
            const scanCanvas = document.createElement('canvas');
            const scanCtx = scanCanvas.getContext && scanCanvas.getContext('2d');

            const scannerSection = document.getElementById('scanner-section');
            const resultsSection = document.getElementById('results-section');
            const switchToManualBtn = document.getElementById('switch-to-manual');
            const manualForm = document.getElementById('manual-lookup-form');
            const regIdInput = document.getElementById('reg-id-input');
            const lookupBtnManual = document.getElementById('lookup-btn');
            const lookupSpinner = document.getElementById('lookup-spinner');

            const feedback = document.getElementById('feedback');
            const cameraStatus = document.getElementById('cameraStatus');

            const resultStatusText = document.getElementById('result-status-badge-text');
            const resultAvatar = document.getElementById('result-avatar');
            const resultName = document.getElementById('result-name');
            const resultRegId = document.getElementById('result-reg-id');
            const resultPhone = document.getElementById('result-phone');
            const resultEmail = document.getElementById('result-email');
            const checkinBtn = document.getElementById('checkin-btn');
            const checkinSpinner = document.getElementById('checkin-spinner');
            const clearBtnBottom = document.getElementById('clear-btn-bottom');
            const scannerBox = document.getElementById('scannerBox');

            let cameraStream = null;
            let scanning = false;
            let current = null;
            let lastLookupMethod = 'qr_scan'; // 'qr_scan' or 'manual_lookup'

            function normalizeStatus(raw) {
                if (!raw) return 'Pending';
                const s = String(raw).toLowerCase();
                if (s.includes('check')) return 'Checked-In';
                if (s.includes('issue') || s.includes('epass')) return 'Issued';
                return raw;
            }

            function showUser(user) {
                current = user;
                if (!user) {
                    resultsSection.classList.add('d-none');
                    scannerSection.classList.remove('d-none');
                    manualForm.classList.add('d-none');
                    feedback.textContent = 'Ready';
                    return;
                }

                // populate result UI
                resultAvatar.src = user.profileUrl || 'https://placehold.co/150x150/6c757d/white?text=No+Photo';
                resultName.textContent = user.fullName || 'Unknown';
                resultRegId.textContent = user.registrationId || '';
                resultPhone.textContent = user.phone || '—';
                resultEmail.textContent = user.email || '—';

                const friendly = normalizeStatus(user.status);
                if (friendly === 'Checked-In') {
                    resultStatusText.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>ALREADY CHECKED IN';
                    checkinBtn.disabled = true;
                } else {
                    resultStatusText.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>VERIFIED';
                    checkinBtn.disabled = false;
                }

                // switch views
                scannerSection.classList.add('d-none');
                resultsSection.classList.remove('d-none');
            }

            // camera control
            async function startCamera() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    video.srcObject = cameraStream;
                    await video.play();
                    video.classList.remove('d-none');
                    videoPlaceholder.classList.add('d-none');
                    if (scannerOverlay) scannerOverlay.classList.remove('d-none');
                    cameraStatus.textContent = 'Camera: On';
                    cameraStatus.classList.remove('bg-secondary');
                    cameraStatus.classList.add('bg-success');
                    scanning = true;
                    requestAnimationFrame(scanFrame);
                } catch (err) {
                    console.warn('camera start failed', err);
                    feedback.textContent = 'Camera denied or not available';
                    manualForm.classList.remove('d-none');
                    cameraStatus.textContent = 'Camera: Error';
                    cameraStatus.classList.remove('bg-success');
                    cameraStatus.classList.add('bg-danger');
                }
            }

            function stopCamera() {
                scanning = false;
                if (cameraStream) {
                    cameraStream.getTracks().forEach(t => t.stop());
                    cameraStream = null;
                }
                try { video.pause(); } catch (e) { }
                video.srcObject = null;
                video.classList.add('d-none');
                videoPlaceholder.classList.remove('d-none');
                if (scannerOverlay) scannerOverlay.classList.add('d-none');
                cameraStatus.textContent = 'Camera: Off';
                cameraStatus.classList.remove('bg-success','bg-danger');
                cameraStatus.classList.add('bg-secondary');
            }

            function playBeep() {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.0001;
                    o.connect(g); g.connect(ctx.destination); o.start();
                    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
                    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
                    setTimeout(() => { try { o.stop(); ctx.close(); } catch (e) { } }, 200);
                } catch (e) { }
            }

            async function scanFrame() {
                try {
                    if (!scanning || !video || !scanCtx) return;
                    const vw = video.videoWidth, vh = video.videoHeight;
                    if (!vw || !vh) { requestAnimationFrame(scanFrame); return; }
                    scanCanvas.width = vw; scanCanvas.height = vh;
                    scanCtx.drawImage(video, 0, 0, vw, vh);
                    const img = scanCtx.getImageData(0, 0, vw, vh);
                    const qr = window.jsQR ? window.jsQR(img.data, img.width, img.height) : null;
                    if (qr && qr.data) { handleScanned(qr.data); return; }
                } catch (err) { console.error('scan error', err); }
                requestAnimationFrame(scanFrame);
            }

            function parseRegistrationFromPayload(text) {
                if (!text) return null;
                try { const j = JSON.parse(text); return j.registrationId || j.registration_id || j.reg || j.id || null; } catch (e) { }
                const m = text.match(/(UP25[-_A-Z0-9]+)/i); if (m) return m[1]; return text.trim();
            }

            function handleScanned(payload) {
                try { playBeep(); if (navigator.vibrate) navigator.vibrate(200); } catch (e) { }
                const id = parseRegistrationFromPayload(payload);
                if (!id) { manualForm.classList.remove('d-none'); feedback.textContent = 'QR scanned but registration ID not found'; return; }
                lastLookupMethod = 'qr_scan';
                stopCamera();
                if (scannerBox) { scannerBox.classList.add('scan-success'); setTimeout(()=>scannerBox.classList.remove('scan-success'),700); }
                setTimeout(() => doLookup(id, lastLookupMethod), 150);
            }

            async function apiLookup(id) {
                const res = await fetch('/.netlify/functions/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'lookup', registrationId: id }) });
                const data = await res.json(); if (!res.ok) throw new Error(data?.message || 'Server error'); return data;
            }

            async function doLookup(id, method = 'manual_lookup') {
                feedback.textContent = 'Looking up…';
                try {
                    lookupSpinner && (lookupSpinner.classList.remove('d-none'));
                    const data = await apiLookup(id);
                    lastLookupMethod = (method === 'qr_scan') ? 'qr_scan' : 'manual_lookup';
                    showUser(data.attendee);
                    feedback.textContent = 'Attendee found';
                } catch (err) {
                    console.error(err);
                    manualForm.classList.remove('d-none');
                    feedback.textContent = err.message || 'Attendee not found';
                    alert(err.message || 'Attendee not found');
                } finally {
                    lookupSpinner && (lookupSpinner.classList.add('d-none'));
                }
            }

            // manual form
            if (switchToManualBtn) switchToManualBtn.addEventListener('click', () => {
                stopCamera(); manualForm.classList.remove('d-none');
                scannerSection.classList.add('d-none');
                regIdInput.focus();
            });

            if (manualForm) manualForm.addEventListener('submit', async (e) => {
                e.preventDefault(); const id = (regIdInput.value || '').trim(); if (!id) { regIdInput.classList.add('is-invalid'); return; }
                regIdInput.classList.remove('is-invalid'); lastLookupMethod = 'manual_lookup'; await doLookup(id, 'manual_lookup');
            });

            // clear / next handlers
            function resetToScanner() {
                resultsSection.classList.add('d-none');
                manualForm.classList.add('d-none');
                scannerSection.classList.remove('d-none');
                // clear result fields
                resultAvatar.src = 'https://placehold.co/150x150/6c757d/white?text=No+Photo';
                resultName.textContent = '';
                resultRegId.textContent = '';
                resultPhone.textContent = '';
                resultEmail.textContent = '';
                // restart camera
                startCamera();
            }

            if (clearBtnBottom) clearBtnBottom.addEventListener('click', resetToScanner);

            // try to get geolocation (promisified)
            function getLocation(timeout = 4000) {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) return resolve(null);
                    let done = false;
                    const onSuccess = (pos) => { if (done) return; done = true; resolve(`${pos.coords.latitude},${pos.coords.longitude}`); };
                    const onFail = () => { if (done) return; done = true; resolve(null); };
                    navigator.geolocation.getCurrentPosition(onSuccess, onFail, { maximumAge: 60*1000, timeout });
                    setTimeout(() => { if (!done) { done = true; resolve(null); } }, timeout+200);
                });
            }

            // check-in
            if (checkinBtn) checkinBtn.addEventListener('click', async () => {
                if (!current) return;
                checkinBtn.disabled = true; checkinSpinner && (checkinSpinner.classList.remove('d-none'));
                feedback.textContent = 'Checking in…';
                try {
                    const location = await getLocation(3500);
                    const payload = { registrationId: current.registrationId, method: lastLookupMethod, location };
                    const res = await fetch('/.netlify/functions/checkin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data?.message || 'Check-in failed');
                    showUser(data.attendee);
                    feedback.textContent = 'Checked in successfully';
                    // small visual confirmation
                    try { playBeep(); if (navigator.vibrate) navigator.vibrate(200); } catch (_) {}
                } catch (err) {
                    console.error(err);
                    feedback.textContent = err.message || 'Check-in failed';
                    alert(err.message || 'Check-in failed');
                } finally {
                    checkinSpinner && (checkinSpinner.classList.add('d-none'));
                    checkinBtn.disabled = current && normalizeStatus(current.status) === 'Checked-In';
                }
            });

            // auto-start camera on load
            window.addEventListener('load', () => { setTimeout(() => { startCamera().catch(()=>{}); }, 250); });
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>