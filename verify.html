<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>E-Pass Verify</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
        <style>
            body { background: #f7f9fc; }
            .scanner-card { max-width: 740px; margin: 36px auto; }
            #video { width:100%; height:auto; border-radius: 8px; display:block; }
            #videoPlaceholder { width:100%; height:320px; background:#e9ecef; display:flex; align-items:center; justify-content:center; border-radius:8px; color:#6c757d; }
            #scannerOverlay { position:absolute; inset:0; pointer-events:none; }
            .scanner-box { width:68%; max-width:420px; height:180px; margin:0 auto; border:3px dashed rgba(255,255,255,0.8); box-shadow:0 6px 18px rgba(0,0,0,0.08); border-radius:12px; }
            .scan-success { animation: flash 0.6s ease; }
            @keyframes flash { 0%{ box-shadow:0 0 0 0 rgba(16,185,129,0.0)} 50%{ box-shadow:0 0 0 10px rgba(16,185,129,0.12)} 100%{ box-shadow:0 0 0 0 rgba(16,185,129,0)} }
            .result-avatar { width:120px; height:120px; object-fit:cover; border-radius:999px; border:4px solid #fff; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
        </style>
    </head>
    <body>
        <header style="background: linear-gradient(135deg,#0ea5a4 0%, #3b82f6 100%); padding:28px 0; color:#fff;">
            <div class="container d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div style="width:48px;height:48px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center">
                        <i class="bi bi-award-fill" style="font-size:20px;color:#fff"></i>
                    </div>
                    <div>
                        <h4 class="mb-0">E-Pass Check-In</h4>
                        <div class="small opacity-75">Fast scanner • QR & Manual • Geolocation</div>
                    </div>
                </div>
                <div class="text-end small opacity-75">Event: <strong>UP25 Conference</strong></div>
            </div>
        </header>

        <main class="container py-4">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card shadow-lg overflow-hidden" style="border-radius:14px;">
                        <div class="row g-0">
                            <div class="col-md-6" style="background: linear-gradient(180deg, rgba(59,130,246,0.06), transparent);">
                                <div class="p-4 d-flex flex-column" style="min-height:360px; align-items:stretch; justify-content:space-between;">
                                    <div>
                                        <h5 class="mb-1">Scanner</h5>
                                        <p class="small text-muted mb-3">Camera will attempt to auto-start. Use manual lookup if camera isn't available.</p>
                                    </div>

                                    <div style="position:relative;">
                                        <video id="video" class="d-none" playsinline muted></video>
                                        <div id="videoPlaceholder" style="height:220px;border-radius:10px;background:#eef2ff;display:flex;align-items:center;justify-content:center;">
                                            <div class="text-center text-primary">
                                                <i class="bi bi-camera-reels" style="font-size:40px"></i>
                                                <div class="small mt-2">Camera preview</div>
                                            </div>
                                        </div>
                                        <div id="scannerOverlay" class="d-none" aria-hidden="true">
                                            <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
                                                <div id="scannerBox" class="scanner-box" style="background:linear-gradient(90deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.04) 100%); overflow:hidden;">
                                                    <div class="scan-beam" aria-hidden="true"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center justify-content-between mt-3">
                                        <div>
                                            <div id="feedback" class="small text-muted">Ready</div>
                                            <div id="loc-display" class="small text-muted mt-1" aria-live="polite"></div>
                                        </div>
                                        <div>
                                            <span id="cameraStatus" class="badge bg-secondary">Camera: Off</span>
                                        </div>
                                    </div>

                                    <div class="mt-3 d-flex gap-2">
                                        <button id="switch-to-manual" class="btn btn-outline-light btn-sm flex-grow-1">Manual lookup</button>
                                        <button id="toggle-camera" class="btn btn-light btn-sm">Toggle</button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 bg-white p-4">
                                <div id="manual-lookup-form" class="mb-3 d-none">
                                    <label for="reg-id-input" class="form-label small">Registration ID</label>
                                    <div class="input-group mb-2">
                                        <input id="reg-id-input" class="form-control" placeholder="UP25-..." aria-label="Registration ID" />
                                        <button id="lookup-btn" class="btn btn-primary">Lookup</button>
                                    </div>
                                    <div id="lookup-spinner" class="spinner-border spinner-border-sm text-primary d-none" role="status"><span class="visually-hidden">Loading</span></div>
                                </div>

                                <div id="results-section" class="text-center d-none">
                                    <div id="result-status-badge" class="mb-2">
                                        <span id="result-status-badge-text" class="badge bg-success">VERIFIED</span>
                                    </div>
                                    <img id="result-avatar" class="result-avatar mb-2" src="https://placehold.co/150x150/6c757d/white?text=No+Photo" alt="avatar" />
                                    <h5 id="result-name" class="mb-0">Name</h5>
                                    <div id="result-reg-id" class="text-danger fw-bold small">REG-0000</div>
                                    <div id="result-phone" class="text-muted small">Phone</div>
                                    <div id="result-email" class="text-muted small">Email</div>
                                    <div id="result-method" class="text-muted small mt-1">Method: <span class="fw-medium">qr_scan</span></div>
                                    <div id="result-location" class="text-muted small mt-1">Location: <span class="fw-medium">—</span></div>
                                    <div id="result-notes" class="text-muted small mt-1">Device: <span class="fw-medium">—</span></div>

                                    <div class="mt-3">
                                        <button id="checkin-btn" class="btn btn-success btn-lg w-100">Confirm Check-In <span id="checkin-spinner" class="spinner-border spinner-border-sm text-light ms-2 d-none" role="status"></span></button>
                                        <button id="clear-btn-bottom" class="btn btn-outline-secondary btn-sm mt-2 w-100">Clear / Next</button>
                                    </div>
                                </div>

                                <div id="empty-state" class="text-center text-muted small">
                                    Scan a QR or use manual lookup to find an attendee.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- toast -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
            <div id="app-toast" class="toast align-items-center text-bg-dark" role="status" aria-live="polite" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <div id="confetti-root" aria-hidden="true"></div>

        <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
        <script>
            // UI enhancements: scan beam animation & confetti
            const scannerBoxEl = document.getElementById('scannerBox');
            if (scannerBoxEl) {
                const style = document.createElement('style');
                style.textContent = `
                    .scan-beam { position:absolute; left:-40%; top:0; width:40%; height:100%; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.18) 50%, rgba(255,255,255,0) 100%); transform:skewX(-12deg); animation: beam 2.2s linear infinite; }
                    @keyframes beam { 0%{ left:-40% } 50%{ left:60% } 100%{ left:-40% } }
                `;
                document.head.appendChild(style);
            }

            function toast(message) {
                const t = document.getElementById('app-toast');
                t.querySelector('.toast-body').textContent = message;
                const bs = new bootstrap.Toast(t, { delay: 2500 });
                bs.show();
            }

            function smallConfetti() {
                const root = document.getElementById('confetti-root');
                if (!root) return;
                for (let i=0;i<24;i++) {
                    const el = document.createElement('div');
                    el.style.position = 'fixed';
                    el.style.left = (50 + (Math.random()-0.5)*40) + '%';
                    el.style.top = '-10px';
                    el.style.width = (6+Math.random()*8)+'px';
                    el.style.height = (8+Math.random()*10)+'px';
                    el.style.background = ['#60a5fa','#34d399','#f472b6','#f59e0b','#a78bfa'][Math.floor(Math.random()*5)];
                    el.style.opacity = '0.95';
                    el.style.borderRadius = '2px';
                    el.style.zIndex = 1200;
                    root.appendChild(el);
                    const fall = el.animate([
                        { transform: 'translateY(0) rotate(0deg)', opacity:1 },
                        { transform: `translateY(${200 + Math.random()*300}px) rotate(${ (Math.random()*720-360) }deg)`, opacity:0.9 }
                    ], { duration: 1200 + Math.random()*900, easing: 'cubic-bezier(.2,.8,.2,1)' });
                    fall.onfinish = () => el.remove();
                }
            }

            // retain core scanning + checkin logic but improve UX and add keyboard shortcuts
            const video = document.getElementById('video');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const scannerOverlay = document.getElementById('scannerOverlay');
            const scanCanvas = document.createElement('canvas');
            const scanCtx = scanCanvas.getContext && scanCanvas.getContext('2d');

            const scannerSection = document.getElementById('scanner-section');
            const resultsSection = document.getElementById('results-section');
            const switchToManualBtn = document.getElementById('switch-to-manual');
            const manualForm = document.getElementById('manual-lookup-form');
            const regIdInput = document.getElementById('reg-id-input');
            const lookupBtnManual = document.getElementById('lookup-btn');
            const lookupSpinner = document.getElementById('lookup-spinner');

            const feedback = document.getElementById('feedback');
            const cameraStatus = document.getElementById('cameraStatus');
            const locDisplay = document.getElementById('loc-display');

            const resultStatusText = document.getElementById('result-status-badge-text');
            const resultAvatar = document.getElementById('result-avatar');
            const resultName = document.getElementById('result-name');
            const resultRegId = document.getElementById('result-reg-id');
            const resultPhone = document.getElementById('result-phone');
            const resultEmail = document.getElementById('result-email');
            const resultMethod = document.getElementById('result-method');
            const resultLocation = document.getElementById('result-location');
            const checkinBtn = document.getElementById('checkin-btn');
            const checkinSpinner = document.getElementById('checkin-spinner');
            const clearBtnBottom = document.getElementById('clear-btn-bottom');
            const toggleCameraBtn = document.getElementById('toggle-camera');

            const emptyState = document.getElementById('empty-state');

            let cameraStream = null;
            let scanning = false;
            let current = null;
            let lastLookupMethod = 'qr_scan'; // 'qr_scan' or 'manual_lookup'

            function normalizeStatus(raw) {
                if (!raw) return 'Pending';
                const s = String(raw).toLowerCase();
                if (s.includes('check')) return 'Checked-In';
                if (s.includes('issue') || s.includes('epass')) return 'Issued';
                return raw;
            }

            function showUser(user) {
                current = user;
                if (!user) {
                    resultsSection.classList.add('d-none');
                    emptyState.classList.remove('d-none');
                    manualForm.classList.add('d-none');
                    feedback.textContent = 'Ready';
                    return;
                }
                emptyState.classList.add('d-none');
                // populate result UI
                resultAvatar.src = user.profileUrl || 'https://placehold.co/150x150/6c757d/white?text=No+Photo';
                resultName.textContent = user.fullName || 'Unknown';
                resultRegId.textContent = user.registrationId || '';
                resultPhone.textContent = user.phone || '—';
                resultEmail.textContent = user.email || '—';

                const friendly = normalizeStatus(user.status);
                if (friendly === 'Checked-In') {
                    resultStatusText.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>ALREADY CHECKED IN';
                    checkinBtn.disabled = true;
                } else {
                    resultStatusText.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>VERIFIED';
                    checkinBtn.disabled = false;
                }

                // display method & location placeholder (filled by checkin response)
                resultMethod.querySelector('span') && (resultMethod.querySelector('span').textContent = lastLookupMethod);
                resultLocation.querySelector('span') && (resultLocation.querySelector('span').textContent = '—');

                // reveal results
                resultsSection.classList.remove('d-none');
            }

            // camera control
            async function startCamera() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    video.srcObject = cameraStream;
                    await video.play();
                    video.classList.remove('d-none');
                    videoPlaceholder.classList.add('d-none');
                    if (scannerOverlay) scannerOverlay.classList.remove('d-none');
                    cameraStatus.textContent = 'Camera: On';
                    cameraStatus.classList.remove('bg-secondary');
                    cameraStatus.classList.add('bg-success');
                    scanning = true;
                    requestAnimationFrame(scanFrame);
                } catch (err) {
                    console.warn('camera start failed', err);
                    feedback.textContent = 'Camera denied or not available';
                    manualForm.classList.remove('d-none');
                    cameraStatus.textContent = 'Camera: Error';
                    cameraStatus.classList.remove('bg-success');
                    cameraStatus.classList.add('bg-danger');
                }
            }

            function stopCamera() {
                scanning = false;
                if (cameraStream) {
                    cameraStream.getTracks().forEach(t => t.stop());
                    cameraStream = null;
                }
                try { video.pause(); } catch (e) { }
                video.srcObject = null;
                video.classList.add('d-none');
                videoPlaceholder.classList.remove('d-none');
                if (scannerOverlay) scannerOverlay.classList.add('d-none');
                cameraStatus.textContent = 'Camera: Off';
                cameraStatus.classList.remove('bg-success','bg-danger');
                cameraStatus.classList.add('bg-secondary');
            }

            function playBeep() {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.0001;
                    o.connect(g); g.connect(ctx.destination); o.start();
                    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
                    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
                    setTimeout(() => { try { o.stop(); ctx.close(); } catch (e) { } }, 200);
                } catch (e) { }
            }

            async function scanFrame() {
                try {
                    if (!scanning || !video || !scanCtx) return;
                    const vw = video.videoWidth, vh = video.videoHeight;
                    if (!vw || !vh) { requestAnimationFrame(scanFrame); return; }
                    scanCanvas.width = vw; scanCanvas.height = vh;
                    scanCtx.drawImage(video, 0, 0, vw, vh);
                    const img = scanCtx.getImageData(0, 0, vw, vh);
                    const qr = window.jsQR ? window.jsQR(img.data, img.width, img.height) : null;
                    if (qr && qr.data) { handleScanned(qr.data); return; }
                } catch (err) { console.error('scan error', err); }
                requestAnimationFrame(scanFrame);
            }

            function parseRegistrationFromPayload(text) {
                if (!text) return null;
                try { const j = JSON.parse(text); return j.registrationId || j.registration_id || j.reg || j.id || null; } catch (e) { }
                const m = text.match(/(UP25[-_A-Z0-9]+)/i); if (m) return m[1]; return text.trim();
            }

            function handleScanned(payload) {
                try { playBeep(); if (navigator.vibrate) navigator.vibrate(200); } catch (e) { }
                const id = parseRegistrationFromPayload(payload);
                if (!id) { manualForm.classList.remove('d-none'); feedback.textContent = 'QR scanned but registration ID not found'; return; }
                lastLookupMethod = 'qr_scan';
                stopCamera();
                if (scannerBoxEl) { scannerBoxEl.classList.add('scan-success'); setTimeout(()=>scannerBoxEl.classList.remove('scan-success'),700); }
                setTimeout(() => doLookup(id, lastLookupMethod), 150);
            }

            async function apiLookup(id) {
                const res = await fetch('/.netlify/functions/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'lookup', registrationId: id }) });
                const data = await res.json(); if (!res.ok) throw new Error(data?.message || 'Server error'); return data;
            }

            async function doLookup(id, method = 'manual_lookup') {
                feedback.textContent = 'Looking up…';
                try {
                    lookupSpinner && (lookupSpinner.classList.remove('d-none'));
                    const data = await apiLookup(id);
                    lastLookupMethod = (method === 'qr_scan') ? 'qr_scan' : 'manual_lookup';
                    showUser(data.attendee);
                    feedback.textContent = 'Attendee found';
                    toast('Attendee found');
                } catch (err) {
                    console.error(err);
                    manualForm.classList.remove('d-none');
                    feedback.textContent = err.message || 'Attendee not found';
                    toast(err.message || 'Attendee not found');
                } finally {
                    lookupSpinner && (lookupSpinner.classList.add('d-none'));
                }
            }

            // manual form
            if (switchToManualBtn) switchToManualBtn.addEventListener('click', () => {
                stopCamera(); manualForm.classList.remove('d-none');
                scannerSection && scannerSection.classList.add('d-none');
                regIdInput.focus();
            });

            if (manualForm) manualForm.addEventListener('submit', async (e) => {
                e.preventDefault(); const id = (regIdInput.value || '').trim(); if (!id) { regIdInput.classList.add('is-invalid'); return; }
                regIdInput.classList.remove('is-invalid'); lastLookupMethod = 'manual_lookup'; await doLookup(id, 'manual_lookup');
            });

            // toggle camera button
            if (toggleCameraBtn) toggleCameraBtn.addEventListener('click', () => { if (scanning) stopCamera(); else startCamera(); });

            // clear / next handlers
            function resetToScanner() {
                resultsSection.classList.add('d-none');
                manualForm.classList.add('d-none');
                scannerSection && scannerSection.classList.remove('d-none');
                // clear result fields
                resultAvatar.src = 'https://placehold.co/150x150/6c757d/white?text=No+Photo';
                resultName.textContent = '';
                resultRegId.textContent = '';
                resultPhone.textContent = '';
                resultEmail.textContent = '';
                resultMethod.querySelector('span') && (resultMethod.querySelector('span').textContent = '—');
                resultLocation.querySelector('span') && (resultLocation.querySelector('span').textContent = '—');
                // restart camera
                startCamera();
            }

            if (clearBtnBottom) clearBtnBottom.addEventListener('click', resetToScanner);

            // try to get geolocation (promisified)
            function getLocation(timeout = 4000) {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) return resolve(null);
                    let done = false;
                    const onSuccess = (pos) => { if (done) return; done = true; resolve(`${pos.coords.latitude},${pos.coords.longitude}`); };
                    const onFail = () => { if (done) return; done = true; resolve(null); };
                    navigator.geolocation.getCurrentPosition(onSuccess, onFail, { maximumAge: 60*1000, timeout });
                    setTimeout(() => { if (!done) { done = true; resolve(null); } }, timeout+200);
                });
            }

            // check-in
            if (checkinBtn) checkinBtn.addEventListener('click', async () => {
                if (!current) return;
                checkinBtn.disabled = true; checkinSpinner && (checkinSpinner.classList.remove('d-none'));
                feedback.textContent = 'Checking in…';
                try {
                    const location = await getLocation(3500);
                    if (location) locDisplay.textContent = `Location: ${location}`;
                    // Detect device info (userAgent/platform and camera info when available)
                    async function detectDeviceInfo() {
                        const info = {
                            userAgent: navigator.userAgent || null,
                            platform: navigator.platform || null,
                            vendor: navigator.vendor || null,
                            cores: navigator.hardwareConcurrency || null,
                            cameraLabel: null
                        };
                        try {
                            if (cameraStream && cameraStream.getVideoTracks && cameraStream.getVideoTracks().length) {
                                const t = cameraStream.getVideoTracks()[0];
                                info.cameraLabel = t.label || (t.getSettings && t.getSettings().deviceId) || null;
                            } else if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                                const devs = await navigator.mediaDevices.enumerateDevices();
                                const v = devs.find(d => d.kind === 'videoinput');
                                if (v) info.cameraLabel = v.label || v.deviceId || null;
                            }
                        } catch (e) { /* ignore */ }
                        return info;
                    }
                    const deviceInfo = await detectDeviceInfo();
                    const payload = { registrationId: current.registrationId, method: lastLookupMethod, location, deviceInfo };
                    const res = await fetch('/.netlify/functions/checkin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data?.message || 'Check-in failed');
                    showUser(data.attendee);
                    // update method & location display with values returned
                    resultMethod.querySelector('span') && (resultMethod.querySelector('span').textContent = payload.method || 'qr_scan');
                    resultLocation.querySelector('span') && (resultLocation.querySelector('span').textContent = payload.location || '—');
                    // show detected device info in results (concise)
                    try {
                        const notesEl = document.querySelector('#result-notes span');
                        if (notesEl) {
                            const label = deviceInfo && (deviceInfo.cameraLabel || deviceInfo.platform || deviceInfo.userAgent) || '—';
                            notesEl.textContent = (typeof label === 'string' && label.length > 80) ? (label.slice(0,77) + '…') : label;
                        }
                    } catch (e) { }
                    feedback.textContent = 'Checked in successfully';
                    toast('Checked in successfully');
                    smallConfetti();
                } catch (err) {
                    console.error(err);
                    feedback.textContent = err.message || 'Check-in failed';
                    toast(err.message || 'Check-in failed');
                } finally {
                    checkinSpinner && (checkinSpinner.classList.add('d-none'));
                    checkinBtn.disabled = current && normalizeStatus(current.status) === 'Checked-In';
                }
            });

            // keyboard shortcuts
            window.addEventListener('keydown', (e) => {
                if (e.key === ' ' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); // space toggles camera
                    if (scanning) stopCamera(); else startCamera();
                }
                if (e.key === 'Escape') { resetToScanner(); }
            });

            // auto-start camera on load
            window.addEventListener('load', () => { setTimeout(() => { startCamera().catch(()=>{}); }, 250); });
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>