<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify & Check-In</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
        integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css"
        integrity="sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="assets/favicon/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="E-Pass">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="icon" href="assets/favicon/favicon.ico">

    <style>
        /* Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bs-font-sans-serif: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bs-primary-rgb: 13, 110, 253;
            --bs-border-radius: 0.5rem;
            --bs-border-radius-lg: 0.75rem;
            --bs-border-radius-pill: 50rem;
            --app-bg: #f8f9fa;
        }

        body {
            background-color: var(--app-bg);
            /* This data-attribute will control the entire UI state */
            data-ui-state: "lookup";
        }

        /* --- App Header --- */
        .app-header {
            background-color: #fff;
            border-bottom: 1px solid #e9ecef;
        }

        /* --- Card Container --- */
        /* Make the card slightly taller on mobile for a better feel */
        .main-card {
            min-height: 75vh;
        }

        @media (min-width: 992px) {
            .main-card {
                min-height: auto;
            }
        }

        /* --- Toast Notification Container --- */
        #message-box-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1080;
            width: 90%;
            max-width: 600px;
        }

        .alert {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        /* --- Main Content Wrapper --- */
        .content-wrapper {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        /* --- Section Styling & Transitions --- */
        #scanner-section,
        #results-section {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            display: none;
            /* Hide by default */
        }

        /* --- UI State Control --- */
        body[data-ui-state="lookup"] #scanner-section,
        body[data-ui-state="scanning"] #scanner-section,
        body[data-ui-state="result"] #results-section,
        body[data-ui-state="loading"] #scanner-section {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Show a spinner over the lookup form while loading */
        body[data-ui-state="loading"] #manual-lookup-form {
            opacity: 0.5;
            pointer-events: none;
        }

        /* --- QR Reader Styles --- */
        #qr-reader-container {
            max-width: 500px;
            margin: 0 auto 1rem;
            position: relative;
            overflow: hidden;
            border-radius: var(--bs-border-radius-lg);
            background: #000;
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #qr-reader {
            width: 100%;
            border: none;
        }

        #qr-reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Active Scan Line Animation */
        #qr-reader-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 10px;
            right: 10px;
            height: 3px;
            background: rgba(var(--bs-primary-rgb), 0.7);
            box-shadow: 0 0 10px rgba(var(--bs-primary-rgb), 0.7);
            border-radius: 3px;
            transform: translateY(-100%);
            animation: scanline 2.5s ease-in-out infinite alternate;
            display: none;
        }

        body[data-ui-state="scanning"] #qr-reader-container::after {
            display: block;
        }

        @keyframes scanline {
            0% {
                transform: translateY(0%);
            }

            100% {
                transform: translateY(calc(100% - 3px));
            }
        }

        /* --- Zoom Controls --- */
        #zoom-controls {
            transition: opacity 0.3s ease;
        }

        /* --- NEW: Button Transitions --- */
        .btn {
            transition: transform 0.15s ease-out;
        }

        .btn:hover {
            transform: scale(1.02);
        }

        /* --- Attendee Result Card --- */
        .result-card {
            position: relative;
        }

        #clear-btn-top {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            z-index: 10;
        }

        #result-status-badge {
            font-size: 1rem;
            font-weight: 600;
            padding: 0.5em 1em;
            border-radius: var(--bs-border-radius-pill);
            margin-bottom: -1.5rem;
            position: relative;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #result-avatar {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .epass-info-block {
            line-height: 1.7;
        }

        .epass-info-block p {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        /* --- NEW: Result Animations --- */
        /* We'll use JS to add the .animate-in class when the state changes to 'result' */
        #results-section .animated {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        #results-section.animate-in #result-status-badge {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.1s;
        }

        #results-section.animate-in #result-avatar {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.2s;
        }

        #results-section.animate-in #result-name {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.3s;
        }

        #results-section.animate-in .epass-info-block {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.4s;
        }

        #results-section.animate-in #checkin-btn,
        #results-section.animate-in #clear-btn-bottom {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.5s;
        }


        /* Heartbeat Animation (Unchanged) */
        .heart {
            color: #e53935;
            animation: heartbeat 1.5s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(1);
            }

            10%,
            30% {
                transform: scale(0.9);
            }

            20% {
                transform: scale(1.1);
            }
        }
    </style>
</head>

<body data-ui-state="lookup">

    <div id="message-box-container" aria-live="polite"></div>

    <header class="app-header p-3">
        <div class="container-fluid">
            <h1 class="h4 mb-0 fw-bold text-primary">
                <i class="bi bi-person-check-fill me-2"></i>E-Pass Check-In
            </h1>
        </div>
    </header>

    <main class="content-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 offset-lg-3">

                    <div class="card shadow-sm border-0 rounded-4 main-card">
                        <div class="card-body p-4 p-md-5">

                            <section id="scanner-section">
                                <h2 class="display-6 fw-bold text-center mb-4">Verify Attendee</h2>

                                <div id="qr-reader-container">
                                    <div id="qr-reader"></div>
                                </div>

                                <div id="zoom-controls" class="mt-2" style="display: none;">
                                    <label for="zoom-slider" class="form-label mb-1 small text-muted">Zoom</label>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-zoom-out me-2"></i>
                                        <input type="range" class="form-range" id="zoom-slider" min="1" max="5"
                                            step="0.1">
                                        <i class="bi bi-zoom-in ms-2"></i>
                                    </div>
                                </div>

                                <button class="btn btn-primary w-100 rounded-pill py-2 mt-3" id="start-scan-btn">
                                    <i class="bi bi-qr-code-scan me-2"></i>
                                    <span id="start-scan-btn-text">Start Camera Scan</span>
                                </button>

                                <hr class="my-4">
                                <h3 class="text-center fs-5 fw-medium mb-3 text-muted">Or, Manual Lookup</h3>

                                <form id="manual-lookup-form" novalidate>
                                    <div class="mb-3">
                                        <label for="reg-id-input" class="form-label">Registration ID</label>
                                        <input type="text" class="form-control" id="reg-id-input"
                                            placeholder="e.g., UP25-..." required>
                                        <div class="invalid-feedback">
                                            Please enter a registration ID.
                                        </div>
                                    </div>
                                    <button type="submit" id="lookup-btn"
                                        class="btn btn-outline-primary w-100 rounded-pill py-2 d-flex align-items-center justify-content-center">
                                        <span id="lookup-btn-text">Find Attendee</span>
                                        <div class="spinner-border spinner-border-sm text-primary ms-2 d-none"
                                            role="status" id="lookup-spinner">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </button>
                                </form>
                            </section>

                            <section id="results-section" class="text-center">

                                <button type="button" class="btn-close" id="clear-btn-top" aria-label="Close"
                                    title="Scan Next"></button>

                                <div id="result-status-badge" class="bg-success text-white animated">
                                    <i class="bi bi-check-circle-fill me-2"></i>VERIFIED
                                </div>

                                <img id="result-avatar" src="https://placehold.co/150x150/6c757d/white?text=No+Photo"
                                    class="img-fluid my-4 animated" alt="Profile Picture">

                                <h2 id="result-name" class="fw-bold fs-3 mb-3 animated"></h2>

                                <div class="epass-info-block text-start bg-light p-3 rounded-3 animated">
                                    <p class="mb-2"><strong>Reg. ID:</strong> <span id="result-reg-id"
                                            class="text-danger fw-bold"></span></p>
                                    <p class="mb-2"><strong>Phone:</strong> <span id="result-phone"></span></p>
                                    <p class="mb-0"><strong>Email:</strong> <span id="result-email"></span></p>
                                </div>

                                <button id="checkin-btn"
                                    class="btn btn-success btn-lg w-100 rounded-pill mt-4 py-2 d-flex align-items-center justify-content-center animated">
                                    <i class="bi bi-person-plus-fill me-2"></i>
                                    <span id="checkin-btn-text">Confirm Check-In</span>
                                    <div class="spinner-border spinner-border-sm text-light ms-2 d-none" role="status"
                                        id="checkin-spinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </button>

                                <button id="clear-btn-bottom"
                                    class="btn btn-outline-secondary w-100 rounded-pill mt-2 py-2 animated">
                                    <i class="bi bi-arrow-left me-2"></i>Scan Next Attendee
                                </button>
                            </section>

                        </div>
                    </div>

                    <footer class="text-center text-muted mt-4">
                        <small>Made with <span class="heart">&hearts;</span> by EllowDigital</small>
                    </footer>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"
        integrity="sha512-HvOjJrdwNpDbkGJIG2ZNqDlVqMo77qbs4Me4cah0HoDrfhrbA+8SBlZn1KrvAQw7cILLPFJvdwIgphzQmMm+Pw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // --- State & Config ---
            const config = {
                api: {
                    verify: '/api/verify',
                    checkIn: '/api/check-in',
                    timeout: 9500,
                },
                placeholders: {
                    avatar: 'https://placehold.co/150x150/6c757d/white?text=No+Photo'
                }
            };

            const appState = {
                currentAttendeeRegId: null,
                scanner: null,
                isScannerRunning: false,
                messageTimeout: null,
                cameraTrack: null
            };

            // --- DOM Element Cache ---
            const ui = {
                body: document.body,
                messageBox: document.getElementById("message-box-container"),

                // Scanner Section
                scannerSection: document.getElementById("scanner-section"),
                startScanBtn: document.getElementById("start-scan-btn"),
                startScanBtnText: document.getElementById("start-scan-btn-text"),
                qrReader: document.getElementById("qr-reader"),
                zoomControls: document.getElementById("zoom-controls"),
                zoomSlider: document.getElementById("zoom-slider"),

                // Lookup Form
                manualForm: document.getElementById("manual-lookup-form"),
                regIdInput: document.getElementById("reg-id-input"),
                lookupBtn: document.getElementById("lookup-btn"),
                lookupBtnText: document.getElementById("lookup-btn-text"),
                lookupSpinner: document.getElementById("lookup-spinner"),

                // Results Section
                resultsSection: document.getElementById("results-section"),
                clearBtnTop: document.getElementById("clear-btn-top"),
                clearBtnBottom: document.getElementById("clear-btn-bottom"),
                resultStatusBadge: document.getElementById("result-status-badge"),
                resultAvatar: document.getElementById("result-avatar"),
                resultName: document.getElementById("result-name"),
                resultRegId: document.getElementById("result-reg-id"),
                resultPhone: document.getElementById("result-phone"),
                resultEmail: document.getElementById("result-email"),
                checkinBtn: document.getElementById("checkin-btn"),
                checkinBtnText: document.getElementById("checkin-btn-text"),
                checkinSpinner: document.getElementById("checkin-spinner"),
            };

            // --- UI Helper Functions ---

            /**
             * Sets the entire application UI state.
             * @param {'lookup' | 'scanning' | 'loading' | 'result'} state
             */
            function setUIState(state) {
                ui.body.dataset.uiState = state;

                if (state === 'scanning') {
                    startScanner();
                } else {
                    stopScanner();
                }

                // NEW: Trigger animations on result state
                if (state === 'result') {
                    // Use a tiny timeout to allow the 'display: block' to apply
                    // before adding the animation class.
                    setTimeout(() => {
                        ui.resultsSection.classList.add('animate-in');
                    }, 10);
                } else {
                    ui.resultsSection.classList.remove('animate-in');
                }

                if (state === 'lookup') {
                    appState.currentAttendeeRegId = null;
                    ui.manualForm.reset();
                    ui.manualForm.classList.remove("was-validated");
                }
            }

            /**
             * Resets the entire UI back to the initial lookup state.
             */
            function resetUI() {
                clearMessage();
                ui.resultAvatar.src = config.placeholders.avatar;
                ui.resultName.textContent = "";
                ui.resultRegId.textContent = "";
                ui.resultPhone.textContent = "";
                ui.resultEmail.textContent = "";
                ui.checkinBtn.disabled = false;
                ui.checkinBtn.classList.replace('btn-secondary', 'btn-success');
                ui.checkinBtnText.textContent = "Confirm Check-In";
                setUIState('lookup');
            }

            /**
             * Shows an auto-hiding toast message.
             */
            function showMessage(message, type = 'info') {
                if (appState.messageTimeout) {
                    clearTimeout(appState.messageTimeout);
                }
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                ui.messageBox.innerHTML = '';
                ui.messageBox.append(wrapper);
                window.scrollTo(0, 0);
                appState.messageTimeout = setTimeout(() => {
                    const alert = wrapper.querySelector('.alert');
                    if (alert) {
                        new bootstrap.Alert(alert).close();
                    }
                }, 5000);
            }

            /**
             * Clears any active message.
             */
            function clearMessage() {
                if (appState.messageTimeout) {
                    clearTimeout(appState.messageTimeout);
                }
                ui.messageBox.innerHTML = '';
            }

            /**
             * Controls the loading spinner state for buttons.
             * (Includes the bugfix from our previous conversation)
             */
            function setLoadingState(isLoading, type) {
                const isCheckin = type === 'checkin';
                const spinner = isCheckin ? ui.checkinSpinner : ui.lookupSpinner;
                const button = isCheckin ? ui.checkinBtn : ui.lookupBtn;
                const btnText = isCheckin ? ui.checkinBtnText : ui.lookupBtnText;
                const loadingText = isCheckin ? "Checking In..." : "Searching...";
                const defaultText = isCheckin ? "Confirm Check-In" : "Find Attendee";

                if (isLoading) {
                    spinner.classList.remove("d-none");
                    button.disabled = true;
                    btnText.textContent = loadingText;
                    if (type === 'lookup') setUIState('loading');
                } else {
                    spinner.classList.add("d-none");
                    button.disabled = false;
                    btnText.textContent = defaultText;

                    // --- BUG FIX ---
                    // Only revert to 'lookup' if we are not already on the 'result' screen.
                    if (type === 'lookup' && ui.body.dataset.uiState !== 'result') {
                        setUIState('lookup');
                    }
                }
            }

            /**
             * Populates the results card with attendee data.
             */
            function displayResults(attendee, isCheckedIn) {
                appState.currentAttendeeRegId = attendee.registration_id;
                ui.resultAvatar.src = attendee.profile_pic_url || config.placeholders.avatar;
                ui.resultName.textContent = attendee.full_name;
                ui.resultRegId.textContent = attendee.registration_id;
                ui.resultPhone.textContent = attendee.phone_number || 'N/A';
                ui.resultEmail.textContent = attendee.email || 'N/A';

                if (isCheckedIn) {
                    ui.resultStatusBadge.className = 'bg-warning text-dark animated';
                    ui.resultStatusBadge.innerHTML = `<i class="bi bi-person-check-fill me-2"></i>ALREADY CHECKED IN`;
                    ui.checkinBtn.disabled = true;
                    ui.checkinBtn.classList.replace('btn-success', 'btn-secondary');
                    ui.checkinBtnText.textContent = "Already Checked-In";
                } else {
                    ui.resultStatusBadge.className = 'bg-success text-white animated';
                    ui.resultStatusBadge.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>VERIFIED - NOT CHECKED IN`;
                    ui.checkinBtn.disabled = false;
                    ui.checkinBtn.classList.replace('btn-secondary', 'btn-success');
                    ui.checkinBtnText.textContent = "Confirm Check-In";
                }
                setUIState('result');
            }

            /**
             * Gets a user-friendly error message.
             */
            function getFriendlyErrorMessage(error) {
                if (error.name === 'AbortError') {
                    return "The request timed out. Network might be slow. Please try again.";
                }
                if (error instanceof TypeError) {
                    return "Network connection failed. Please check your internet and try again.";
                }
                return error.message || "An unknown error occurred. Please try again.";
            }

            // --- API & Data Logic ---

            /**
             * A fetch wrapper with a timeout and no-cache policy.
             */
            async function fetchWithTimeout(url, options, timeout = config.api.timeout) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    cache: 'no-store'
                });
                clearTimeout(id);
                return response;
            }

            /**
             * Fetches attendee data from the API.
             */
            async function fetchAttendee(registrationId) {
                if (!registrationId) {
                    showMessage("Invalid Registration ID.", "danger");
                    return;
                }
                clearMessage();
                setLoadingState(true, 'lookup');
                try {
                    const response = await fetchWithTimeout(config.api.verify, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ registrationId: registrationId.trim().toUpperCase() })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.message || `HTTP error! Status: ${response.status}`);
                    }
                    if (!result.data || !result.data.attendee) {
                        throw new Error("Invalid data received from server.");
                    }
                    displayResults(result.data.attendee, result.data.isCheckedIn);
                } catch (error) {
                    console.error("Fetch Attendee failed:", error);
                    const friendlyMessage = getFriendlyErrorMessage(error);
                    showMessage(friendlyMessage, "danger");
                } finally {
                    setLoadingState(false, 'lookup');
                }
            }

            /**
             * Performs the check-in API call.
             */
            async function performCheckIn() {
                if (!appState.currentAttendeeRegId) return;
                setLoadingState(true, 'checkin');
                try {
                    const response = await fetchWithTimeout(config.api.checkIn, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ registrationId: appState.currentAttendeeRegId })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        // This will catch the 500 error and show its message
                        throw new Error(result.message || `HTTP error! Status: ${response.status}`);
                    }
                    showMessage("Check-In Successful!", "success");
                    ui.resultStatusBadge.className = 'bg-success text-white animated';
                    ui.resultStatusBadge.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>CHECK-IN COMPLETE`;
                    ui.checkinBtn.disabled = true;
                    ui.checkinBtn.classList.replace('btn-success', 'btn-secondary');
                    ui.checkinBtnText.textContent = "Checked-In";
                } catch (error) {
                    console.error("Check-In failed:", error);
                    const friendlyMessage = getFriendlyErrorMessage(error);
                    showMessage(friendlyMessage, "danger");
                } finally {
                    setLoadingState(false, 'checkin');
                }
            }

            // --- QR Scanner Logic ---

            function onScanSuccess(decodedText, decodedResult) {
                console.log(`Scan result: ${decodedText}`);
                try {
                    const data = JSON.parse(decodedText);
                    if (data && data.regId) {
                        fetchAttendee(data.regId);
                    } else {
                        throw new Error("Invalid QR code format (JSON).");
                    }
                } catch (jsonError) {
                    console.warn("QR code is not JSON, treating as plain text ID.");
                    if (decodedText && decodedText.trim().length > 0) {
                        fetchAttendee(decodedText);
                    } else {
                        console.error("QR Parse Error:", jsonError);
                        showMessage("Invalid E-Pass QR Code. Please try manual lookup.", "danger");
                    }
                }
            }

            function onScanFailure(error) {
                // This fires continuously. It's safe to ignore.
            }

            /**
             * Initializes zoom controls using standard browser APIs.
             */
            function initializeZoomControls() {
                try {
                    const videoElement = ui.qrReader.querySelector('video');
                    if (!videoElement || !videoElement.srcObject) {
                        console.warn("Could not find video element to apply zoom.");
                        ui.zoomControls.style.display = 'none';
                        return;
                    }
                    const track = videoElement.srcObject.getVideoTracks()[0];
                    if (!track) {
                        console.warn("Could not find video track.");
                        ui.zoomControls.style.display = 'none';
                        return;
                    }
                    const capabilities = track.getCapabilities();
                    const settings = track.getSettings();
                    if (capabilities && capabilities.zoom) {
                        appState.cameraTrack = track; // Store the track
                        const { min, max, step } = capabilities.zoom;
                        ui.zoomSlider.min = min;
                        ui.zoomSlider.max = max;
                        ui.zoomSlider.step = step;
                        ui.zoomSlider.value = settings.zoom || min;
                        ui.zoomControls.style.display = 'block'; // Show controls
                        console.log(`Zoom enabled: min=${min}, max=${max}, current=${settings.zoom}`);
                    } else {
                        console.warn("Zoom is not supported by this camera.");
                        ui.zoomControls.style.display = 'none'; // Hide if not supported
                    }
                } catch (err) {
                    console.error("Error getting camera capabilities:", err);
                    ui.zoomControls.style.display = 'none'; // Hide on error
                }
            }

            function startScanner() {
                if (appState.isScannerRunning) return;
                if (!appState.scanner) {
                    appState.scanner = new Html5Qrcode("qr-reader");
                }
                const scannerConfig = {
                    fps: 10,
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        const size = Math.floor(minEdge * 0.75); // 75% of smallest dimension
                        return { width: size, height: size };
                    },
                    rememberLastUsedCamera: true
                };

                appState.scanner.start({ facingMode: "environment" }, scannerConfig, onScanSuccess, onScanFailure)
                    .then(() => {
                        console.log("Scanner started with back camera.");
                        appState.isScannerRunning = true;
                        ui.startScanBtnText.textContent = "Scanning... (Point at QR Code)";
                        ui.startScanBtn.disabled = true;
                        setUIState('scanning');
                        initializeZoomControls();
                    })
                    .catch((err) => {
                        console.warn("Back camera failed, trying any camera:", err);
                        appState.scanner.start({}, scannerConfig, onScanSuccess, onScanFailure)
                            .then(() => {
                                console.log("Scanner started with default camera.");
                                appState.isScannerRunning = true;
                                ui.startScanBtnText.textContent = "Scanning... (Point at QR Code)";
                                ui.startScanBtn.disabled = true;
                                setUIState('scanning');
                                initializeZoomControls();
                            })
                            .catch((err2) => {
                                console.error("Failed to start any camera:", err2);
                                showMessage("Could not start camera. Please grant permissions or use manual lookup.", "danger");
                                setUIState('lookup');
                            });
                    });
            }

            function stopScanner() {
                ui.zoomControls.style.display = 'none';
                appState.cameraTrack = null;
                if (appState.scanner && appState.isScannerRunning) {
                    try {
                        appState.scanner.stop().then(() => {
                            console.log("Scanner stopped.");
                        }).catch(err => {
                            console.warn("Scanner already stopped or failed to stop:", err);
                        }).finally(() => {
                            appState.isScannerRunning = false;
                            ui.startScanBtnText.textContent = "Start Camera Scan";
                            ui.startScanBtn.disabled = false;
                        });
                    } catch (err) {
                        console.warn("Scanner stop error:", err);
                        appState.isScannerRunning = false;
                        appState.cameraTrack = null;
                        ui.startScanBtnText.textContent = "Start Camera Scan";
                        ui.startScanBtn.disabled = false;
                    }
                }
            }

            // --- Event Listeners (Initialization) ---

            ui.startScanBtn.addEventListener("click", () => {
                setUIState('scanning');
            });

            ui.zoomSlider.addEventListener('input', () => {
                if (appState.cameraTrack && appState.isScannerRunning) {
                    try {
                        const zoomValue = parseFloat(ui.zoomSlider.value);
                        appState.cameraTrack.applyConstraints({
                            advanced: [{ zoom: zoomValue }]
                        });
                    } catch (err) {
                        console.warn("Could not apply zoom:", err);
                    }
                }
            });

            ui.manualForm.addEventListener("submit", (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!ui.manualForm.checkValidity()) {
                    ui.manualForm.classList.add("was-validated");
                    return;
                }
                ui.manualForm.classList.add("was-validated");
                fetchAttendee(ui.regIdInput.value);
            });

            ui.checkinBtn.addEventListener("click", performCheckIn);
            ui.clearBtnTop.addEventListener("click", resetUI);
            ui.clearBtnBottom.addEventListener("click", resetUI);

            // --- Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                });
            }
        });
    </script>
</body>

</html>