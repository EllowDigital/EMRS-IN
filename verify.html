<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Verify EMRS e-passes quickly via QR scan or manual lookup." />
  <meta name="keywords"
    content="EMRS verification, EllowDigital pass checker, QR code scan, attendee lookup" />
  <meta name="author" content="EllowDigital" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Verify E-Pass – EMRS</title>
  <link rel="canonical" href="https://get-epass.netlify.app/verify.html" />
  <meta property="og:title" content="Verify EMRS Pass" />
  <meta property="og:description" content="Scan QR codes or search manually to verify EMRS attendees on the go." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://get-epass.netlify.app/verify.html" />
  <meta property="og:site_name" content="EMRS by EllowDigital" />
  <meta property="og:locale" content="en_IN" />
  <meta property="og:image" content="https://get-epass.netlify.app/assets/images/emrs-logo.png" />
  <meta property="og:image:alt" content="Verify EMRS QR passes" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Verify EMRS Pass" />
  <meta name="twitter:description" content="Scan QR codes or search manually to verify EMRS attendees on the go." />
  <meta name="twitter:image" content="https://get-epass.netlify.app/assets/images/emrs-logo.png" />
  <meta name="twitter:image:alt" content="Verify EMRS QR passes" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0a2540" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="EMRS Verify" />
  <link rel="icon" type="image/x-icon" href="assets/favicon/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png" />
  <link rel="stylesheet" href="assets/css/tailwind-built.css" />

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      color-scheme: light;
    }

    body {
      background: radial-gradient(circle at top,
          #edf2f9 0%,
          #e0e7f1 45%,
          #d6deeb 100%);
      font-family:
        "Inter",
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        sans-serif;
      min-height: 100vh;
    }

    /* * IMPROVEMENT: Removed #qr-reader and its media query. 
         * Responsiveness is now handled by Tailwind classes on the #qr-reader div itself.
         */
    @supports not (aspect-ratio: 1 / 1) {
      #qr-reader {
        /* Fallback for very old browsers */
        height: 18rem;
      }

      @media (min-width: 640px) {
        #qr-reader {
          height: 22rem;
        }
      }
    }

    .card-surface {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 40px rgba(10, 37, 64, 0.18);
      border-radius: 1.25rem;
      border: 1px solid rgba(10, 37, 64, 0.08);
    }

    /* * IMPROVEMENT: Removed .scan-laser max-width properties. 
         * The parent [data-scan-container] now controls the size.
         */
    .scan-laser::before {
      content: "";
      position: absolute;
      inset: 0;
      border: 2px solid rgba(10, 37, 64, 0.12);
      border-radius: 1rem;
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
    }

    .scan-laser::after {
      content: "";
      position: absolute;
      left: 10%;
      right: 10%;
      height: 3px;
      background: linear-gradient(90deg,
          transparent,
          rgba(13, 110, 253, 0.85),
          transparent);
      border-radius: 999px;
      animation: none;
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
    }

    .scan-laser.camera-active::before {
      opacity: 1;
    }

    .scan-laser.camera-active::after {
      opacity: 1;
      animation: sweep 2.2s ease-in-out infinite;
    }

    .scanner-overlay-message {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      text-align: center;
      font-size: 0.9375rem;
      font-weight: 600;
      color: #475569;
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(6px);
      border-radius: 1rem;
      pointer-events: none;
    }

    .scanner-overlay-message button { pointer-events: all; }

    @keyframes sweep {
      0% {
        top: 12%;
        opacity: 0.2;
      }

      50% {
        top: 50%;
        opacity: 1;
      }

      100% {
        top: 86%;
        opacity: 0.2;
      }
    }

    .modal-backdrop {
      background: rgba(10, 37, 64, 0.45);
    }

    .modal-card {
      background: #fff;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 24rem;
      width: 100%;
      box-shadow: 0 18px 40px rgba(10, 37, 64, 0.25);
    }

    .shake {
      animation: shake 0.4s ease-in-out forwards;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-6px);
      }

      75% {
        transform: translateX(6px);
      }
    }
  </style>
</head>

<body class="flex flex-col">
  <nav class="bg-white/80 backdrop-blur border-b border-slate-200/50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-2 text-slate-900">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-slate-900 text-white"
          aria-hidden="true">
          <i class="fas fa-qrcode"></i>
        </span>
        <div>
          <p class="text-lg font-semibold">Verify E-Pass</p>
          <p class="text-xs text-slate-500">
            EMRS Admin Authentication Portal
          </p>
        </div>
      </div>
      <div class="flex flex-wrap gap-2" role="group">
        <a href="admin.html"
          class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 transition hover:border-slate-400 hover:text-slate-900">
          <i class="fas fa-solar-panel text-slate-500" aria-hidden="true"></i>
          Admin Page
        </a>
        <a href="index.html"
          class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition hover:border-slate-400 hover:text-slate-900">
          <i class="fas fa-home text-slate-500" aria-hidden="true"></i> Main
          Site
        </a>
        <a href="form.html"
          class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-700">
          <i class="fas fa-user-plus" aria-hidden="true"></i> Register
          Attendee
        </a>
        <button id="logoutBtn" type="button"
          class="hidden items-center gap-2 rounded-full border border-rose-200 bg-white px-4 py-2 text-sm font-semibold text-rose-600 transition hover:border-rose-300 hover:text-rose-700">
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Sign Out
        </button>
      </div>
    </div>
  </nav>

  <main class="flex-1 flex justify-center px-4 py-8 sm:py-10">
    <div class="w-full max-w-5xl">
      <div class="grid gap-6 lg:gap-8">
        <section id="loginBlock" class="card-surface hidden p-6 sm:p-8 transition" data-block="login" role="region"
          aria-labelledby="login-heading">
          <div class="mx-auto max-w-md text-center">
            <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-indigo-100 text-indigo-600"
              aria-hidden="true">
              <i class="fas fa-lock text-2xl"></i>
            </div>
            <h2 id="login-heading" class="mt-6 text-2xl font-semibold text-slate-900">
              Staff Sign-In
            </h2>
            <p class="mt-2 text-sm leading-6 text-slate-500">
              Enter the admin password once to unlock scanning and manual
              verification for this session.
            </p>
            <form id="loginForm" class="mt-6 space-y-4">
              <div class="text-left">
                <label for="loginPasswordInput" class="block text-sm font-semibold text-slate-700">Admin
                  Password</label>
                <input id="loginPasswordInput" type="password" autocomplete="current-password"
                  class="mt-2 w-full rounded-xl border border-slate-200/80 bg-white px-4 py-3 text-slate-900 shadow-sm focus:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Enter password" required />
              </div>
              <p id="loginErrorMessage" class="hidden text-sm font-semibold text-rose-600" aria-live="polite"></p>
              <button id="loginSubmitBtn" type="submit"
                class="inline-flex w-full items-center justify-center gap-2 rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-indigo-700">
                <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                <span>Sign In</span>
              </button>
            </form>
          </div>
        </section>

        <section id="scannerBlock" class="card-surface hidden p-6 sm:p-8 transition" data-block="scanner" role="region"
          aria-labelledby="scanner-heading">
          <div class="flex flex-col gap-6">
            <div>
              <h2 id="scanner-heading" class="text-2xl font-semibold text-slate-900">
                QR Scanner
              </h2>
              <p class="mt-2 text-sm leading-6 text-slate-500">
                Point the camera at the visitor's QR code to validate their
                pass instantly. Keep the code inside the boundary for best
                results.
              </p>
            </div>
            <div class="relative rounded-2xl bg-slate-100 p-4 sm:p-6">
              <div class="scan-laser relative overflow-hidden rounded-2xl w-full max-w-[18rem] sm:max-w-[22rem] mx-auto"
                data-scan-container>
                <div id="qr-reader" class="w-full aspect-square"></div>
                <div id="scannerOverlayMessage" class="scanner-overlay-message" role="status" aria-live="polite">
                  <span id="scannerOverlayText">Camera is off. Sign in to start scanning.</span>
                  <div id="permissionErrorUI" class="hidden" aria-live="polite">
                    <h3 class="text-lg font-semibold">Camera Permission Denied</h3>
                    <p id="permissionErrorMessage" class="text-sm text-slate-500">Browser blocked camera access. Please enable camera permission for this site in your browser settings and retry.</p>
                    <button id="reloadPermissionBtn" type="button" class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white">Retry Permission</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex flex-wrap gap-3">
              <button id="toggleCameraBtn" type="button"
                class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800">
                <i class="fas fa-video" aria-hidden="true"></i>
                <span>Turn Camera Off</span>
              </button>
              <button id="manualTriggerBtn" type="button"
                class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-white px-4 py-2 text-sm font-semibold text-indigo-600 transition hover:border-indigo-300 hover:text-indigo-700">
                <i class="fas fa-keyboard" aria-hidden="true"></i> Verify
                Manually
              </button>
            </div>
            <p id="scannerErrorMessage" class="hidden text-sm font-semibold text-red-600" aria-live="polite"></p>
          </div>
        </section>

        <section id="manualBlock" class="card-surface hidden p-8 transition" data-block="manual" role="region"
          aria-labelledby="manual-heading">
          <div class="mx-auto max-w-xl">
            <h2 id="manual-heading" class="text-2xl font-semibold text-slate-900">
              Manual Verification
            </h2>
            <p class="mt-2 text-sm leading-6 text-slate-500">
              Enter the registration ID exactly as shown on the e-pass.
            </p>
            <div class="mt-6 space-y-4">
              <label class="block text-sm font-semibold text-slate-700" for="manualInput">Registration ID</label>
              <input id="manualInput" type="text" placeholder="EMRS-2025-0001"
                class="w-full rounded-xl border border-slate-200/80 bg-white px-4 py-3 text-slate-900 shadow-sm focus:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
              <div class="flex flex-wrap gap-3 pt-2">
                <button id="manualSearchBtn" type="button"
                  class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-indigo-700">
                  <i class="fas fa-search" aria-hidden="true"></i> Search
                </button>
                <button id="backToScannerBtn" type="button"
                  class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800">
                  <i class="fas fa-arrow-left" aria-hidden="true"></i> Back to
                  Scanner
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="resultBlock" class="card-surface hidden p-6 sm:p-8 transition" data-block="result" role="region"
          aria-labelledby="result-heading">
          <div class="flex flex-col gap-6 lg:flex-row lg:gap-8">
            <div class="flex justify-center lg:w-1/3">
              <div class="relative">
                <img id="resultPhoto" src="" alt="Profile"
                  class="h-40 w-40 rounded-full border-4 border-white object-cover shadow-xl sm:h-48 sm:w-48" />
                <span
                  class="absolute -bottom-3 left-1/2 -translate-x-1/2 rounded-full bg-green-600 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white shadow">Verified</span>
              </div>
            </div>
            <div class="lg:w-2/3">
              <p id="result-heading" class="text-sm font-semibold uppercase tracking-wide text-indigo-500">
                Attendee Details
              </p>
              <h2 id="resultName" class="mt-2 text-3xl font-semibold text-slate-900"></h2>
              <div class="mt-4 grid gap-3">
                <div class="rounded-xl border border-slate-200/80 bg-white/70 px-4 py-3">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    Registration ID
                  </p>
                  <p id="resultRegId" class="mt-1 text-lg font-semibold text-slate-900"></p>
                </div>
                <div class="rounded-xl border border-slate-200/80 bg-white/70 px-4 py-3">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    Pass Type
                  </p>
                  <p id="resultPassType" class="mt-1 text-lg text-slate-800"></p>
                </div>
                <div class="rounded-xl border border-slate-200/80 bg-white/70 px-4 py-3">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    Status
                  </p>
                  <p id="resultStatus" class="mt-1 text-lg font-semibold text-green-600"></p>
                </div>
              </div>
              <div class="mt-6 flex flex-wrap gap-3">
                <button id="checkedInBtn" type="button"
                  class="inline-flex items-center gap-2 rounded-full bg-green-600 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-green-700">
                  <i class="fas fa-check" aria-hidden="true"></i> Mark as
                  Checked-In
                </button>
                <button id="newScanBtn" type="button"
                  class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800">
                  <i class="fas fa-redo" aria-hidden="true"></i> New Scan
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div id="scanFailureModal" class="fixed inset-0 z-40 hidden items-center justify-center" role="dialog"
    aria-modal="true" aria-labelledby="scanFailure-heading">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative modal-card text-center">
      <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-orange-100 text-orange-500"
        aria-hidden="true">
        <i class="fas fa-exclamation-triangle text-2xl"></i>
      </div>
      <h3 id="scanFailure-heading" class="mt-4 text-xl font-semibold text-slate-900">
        No QR detected yet
      </h3>
      <p class="mt-2 text-sm text-slate-500">
        Would you like to keep scanning or switch to manual verification?
      </p>
      <div class="mt-5 flex flex-col gap-2">
        <button id="keepScanningBtn" type="button"
          class="w-full rounded-full bg-slate-900 px-5 py-2 text-sm font-semibold text-white transition hover:bg-slate-800">
          Keep Scanning
        </button>
        <button id="switchManualBtn" type="button"
          class="w-full rounded-full border border-slate-200 bg-white px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900">
          Type Manually
        </button>
      </div>
    </div>
  </div>

  <div id="notFoundModal" class="fixed inset-0 z-40 hidden items-center justify-center" role="dialog" aria-modal="true"
    aria-labelledby="notFound-heading">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative modal-card text-center">
      <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 text-red-500"
        aria-hidden="true">
        <svg id="notFoundIcon" class="h-9 w-9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="9" />
          <line x1="9" y1="9" x2="15" y2="15" />
          <line x1="15" y1="9" x2="9" y2="15" />
        </svg>
      </div>
      <h3 id="notFound-heading" class="mt-4 text-xl font-semibold text-slate-900">
        Oops! Not Found
      </h3>
      <p class="mt-2 text-sm text-slate-500">
        We couldn't match that registration ID. Please check and try again.
      </p>
      <div class="mt-5 flex flex-col gap-2">
        <button id="notFoundCloseBtn" type="button"
          class="w-full rounded-full bg-slate-900 px-5 py-2 text-sm font-semibold text-white transition hover:bg-slate-800">
          Try Another
        </button>
      </div>
    </div>
  </div>

  <footer class="py-6 text-center text-xs text-slate-500">
    <p>EMRS Verification Portal · Crafted by EllowDigital</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/js/all.min.js" defer></script>

  <script>
    (() => {
      const ADMIN_KEY_STORAGE_KEY = "EMRS_ADMIN_SESSION_KEY";
      const AUTH_REQUIRED_CODE = "AUTH_REQUIRED";
      const HTML5_QRCODE_SRC = "assets/vendor/html5-qrcode.min.js";
      const SCAN_TIMEOUT_MS = 5000;
      const DEFAULT_PERMISSION_GUIDANCE =
        "Browser blocked camera access. Please enable camera permission for this site in your browser settings and retry.";

      if (typeof sessionStorage !== "undefined") {
        try {
          sessionStorage.removeItem(ADMIN_KEY_STORAGE_KEY);
        } catch (storageError) {
          console.warn("Unable to reset stored admin key", storageError);
        }
      }

      const blocks = {
        login: document.getElementById("loginBlock"),
        scanner: document.getElementById("scannerBlock"),
        manual: document.getElementById("manualBlock"),
        result: document.getElementById("resultBlock"),
      };

      const modals = {
        scanFailure: document.getElementById("scanFailureModal"),
        notFound: document.getElementById("notFoundModal"),
      };

      const elements = {
        toggleCameraBtn: document.getElementById("toggleCameraBtn"),
        manualTriggerBtn: document.getElementById("manualTriggerBtn"),
        manualInput: document.getElementById("manualInput"),
        manualSearchBtn: document.getElementById("manualSearchBtn"),
        backToScannerBtn: document.getElementById("backToScannerBtn"),
        keepScanningBtn: document.getElementById("keepScanningBtn"),
        switchManualBtn: document.getElementById("switchManualBtn"),
        notFoundCloseBtn: document.getElementById("notFoundCloseBtn"),
        resultPhoto: document.getElementById("resultPhoto"),
        resultName: document.getElementById("resultName"),
        resultRegId: document.getElementById("resultRegId"),
        resultPassType: document.getElementById("resultPassType"),
        resultStatus: document.getElementById("resultStatus"),
        checkedInBtn: document.getElementById("checkedInBtn"),
        newScanBtn: document.getElementById("newScanBtn"),
        notFoundIcon: document.getElementById("notFoundIcon"),
        scannerErrorMessage: document.getElementById("scannerErrorMessage"),
        loginForm: document.getElementById("loginForm"),
        loginPasswordInput: document.getElementById("loginPasswordInput"),
        loginSubmitBtn: document.getElementById("loginSubmitBtn"),
        loginErrorMessage: document.getElementById("loginErrorMessage"),
        logoutBtn: document.getElementById("logoutBtn"),
        scanContainer: document.querySelector("[data-scan-container]"),
        scannerOverlayMessage: document.getElementById(
          "scannerOverlayMessage",
        ),
        scannerOverlayText: document.getElementById("scannerOverlayText"),
        permissionErrorUI: document.getElementById("permissionErrorUI"),
        permissionErrorMessage: document.getElementById(
          "permissionErrorMessage",
        ),
      };

      if (!elements.loginForm) {
        return;
      }

      updateScannerState(
        "inactive",
        "Camera is off. Sign in to start scanning.",
      );

      const loginButtonDefaultText =
        elements.loginSubmitBtn?.querySelector("span")?.textContent?.trim() ||
        "Sign In";

      const state = {
        adminKey: null,
        currentRegistrationId: null,
        currentRecord: null,
        cameraPermissionGranted: false,
      };

      let html5QrCode = null;
      let isCameraActive = false;
      let scanFailureTimer = null;
      let audioContext = null;

      function ensureAudioContext() {
        if (audioContext) {
          if (audioContext.state === "suspended") {
            audioContext.resume().catch(() => null);
          }
          return audioContext;
        }
        const AudioContextClass =
          window.AudioContext || window.webkitAudioContext;
        if (!AudioContextClass) {
          console.warn("Web Audio API is not supported in this browser.");
          return null;
        }
        audioContext = new AudioContextClass();
        if (audioContext.state === "suspended") {
          audioContext.resume().catch(() => null);
        }
        return audioContext;
      }

      async function playTone({
        frequency = 880,
        duration = 160,
        type = "sine",
        volume = 0.15,
      } = {}) {
        const ctx = ensureAudioContext();
        if (!ctx) {
          return;
        }
        try {
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();
          oscillator.type = type;
          oscillator.frequency.value = frequency;
          gainNode.gain.value = 0;
          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);
          const now = ctx.currentTime;
          const endTime = now + duration / 1000;
          gainNode.gain.setValueAtTime(0, now);
          gainNode.gain.linearRampToValueAtTime(volume, now + 0.02);
          gainNode.gain.linearRampToValueAtTime(0, endTime);
          oscillator.start(now);
          oscillator.stop(endTime);
          await new Promise((resolve) => {
            oscillator.onended = resolve;
          });
        } catch (audioError) {
          console.warn("Audio playback failed", audioError);
        }
      }

      function playScanSuccessSound() {
        playTone({ frequency: 980, duration: 140, volume: 0.14 }).catch(
          () => null,
        );
      }

      async function playCheckInSound() {
        try {
          await playTone({ frequency: 620, duration: 120, volume: 0.16 });
          await playTone({ frequency: 880, duration: 160, volume: 0.16 });
        } catch (audioError) {
          console.warn("Check-in sound failed", audioError);
        }
      }

      function resetPermissionOverlay() {
        if (elements.permissionErrorUI) {
          elements.permissionErrorUI.classList.add("hidden");
        }
        if (elements.permissionErrorMessage) {
          elements.permissionErrorMessage.textContent =
            DEFAULT_PERMISSION_GUIDANCE;
        }
        if (elements.scannerOverlayText) {
          elements.scannerOverlayText.style.display = "block";
        }
      }

      function showCameraPermissionError(details) {
        const overlay = elements.scannerOverlayMessage;
        if (!overlay) {
          return;
        }
        if (elements.scanContainer) {
          elements.scanContainer.classList.remove("camera-active");
        }
        overlay.style.display = "flex";
        if (elements.scannerOverlayText) {
          elements.scannerOverlayText.style.display = "none";
        }
        if (elements.permissionErrorUI) {
          elements.permissionErrorUI.classList.remove("hidden");
        }
        if (elements.permissionErrorMessage) {
          elements.permissionErrorMessage.textContent =
            details || DEFAULT_PERMISSION_GUIDANCE;
        }
      }

      async function getCameraPermissionState() {
        if (!navigator.permissions?.query) {
          return "prompt";
        }
        try {
          const status = await navigator.permissions.query({ name: "camera" });
          return status.state;
        } catch (error) {
          console.debug("Unable to determine camera permission state", error);
          return "prompt";
        }
      }

      function updateScannerState(status, message = "") {
        const container = elements.scanContainer;
        const overlay = elements.scannerOverlayMessage;
        if (!container || !overlay) {
          return;
        }
        const overlayText = elements.scannerOverlayText;
        if (status === "active") {
          container.classList.add("camera-active");
          overlay.style.display = "none";
          resetPermissionOverlay();
          if (overlayText) {
            overlayText.textContent = "";
          }
          return;
        }

        container.classList.remove("camera-active");
        overlay.style.display = "flex";
        resetPermissionOverlay();
        const displayMessage =
          message ||
          (status === "starting"
            ? "Initializing camera..."
            : "Camera is currently off.");
        if (overlayText) {
          overlayText.textContent = displayMessage;
        }
      }

      const loadHtml5Qrcode = (() => {
        let loaderPromise = null;
        return () => {
          if (window.Html5Qrcode) {
            return Promise.resolve();
          }
          if (!loaderPromise) {
            loaderPromise = new Promise((resolve, reject) => {
              const script = document.createElement("script");
              script.src = HTML5_QRCODE_SRC;
              script.async = true;
              script.onload = () => {
                if (window.Html5Qrcode) {
                  resolve();
                } else {
                  reject(new Error("QR scanner failed to initialize."));
                }
              };
              script.onerror = () =>
                reject(new Error("Unable to load QR scanner library."));
              document.head.appendChild(script);
            });
          }
          return loaderPromise;
        };
      })();

      function showBlock(target) {
        Object.entries(blocks).forEach(([key, section]) => {
          if (!section) {
            return;
          }
          if (key === target) {
            section.classList.remove("hidden");
          } else {
            section.classList.add("hidden");
          }
        });
      }

      function showModal(modal) {
        if (!modal) {
          return;
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function hideModal(modal) {
        if (!modal) {
          return;
        }
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      function setScannerError(message) {
        if (!elements.scannerErrorMessage) {
          return;
        }
        if (message) {
          elements.scannerErrorMessage.textContent = message;
          elements.scannerErrorMessage.classList.remove("hidden");
        } else {
          elements.scannerErrorMessage.textContent = "";
          elements.scannerErrorMessage.classList.add("hidden");
        }
      }

      function setLoginError(message) {
        if (!elements.loginErrorMessage) {
          return;
        }
        if (message) {
          elements.loginErrorMessage.textContent = message;
          elements.loginErrorMessage.classList.remove("hidden");
        } else {
          elements.loginErrorMessage.textContent = "";
          elements.loginErrorMessage.classList.add("hidden");
        }
      }

      function setLoginLoading(isLoading) {
        if (!elements.loginSubmitBtn) {
          return;
        }
        elements.loginSubmitBtn.disabled = isLoading;
        const label = elements.loginSubmitBtn.querySelector("span");
        if (label) {
          label.textContent = isLoading
            ? "Signing In..."
            : loginButtonDefaultText;
        }
      }

      async function stopCamera(
        message = "Camera is off. Tap Turn Camera On to resume scanning.",
      ) {
        if (
          html5QrCode &&
          isCameraActive &&
          typeof html5QrCode.stop === "function"
        ) {
          try {
            await html5QrCode.stop();
          } catch (stopError) {
            console.warn("Unable to stop camera cleanly", stopError);
          }
        }
        if (html5QrCode && typeof html5QrCode.clear === "function") {
          try {
            await html5QrCode.clear();
          } catch (clearError) {
            console.warn("Unable to clear QR scanner display", clearError);
          }
        }
        isCameraActive = false;
        if (elements.toggleCameraBtn) {
          const label = elements.toggleCameraBtn.querySelector("span");
          const icon = elements.toggleCameraBtn.querySelector("i");
          if (label) {
            label.textContent = "Turn Camera On";
          }
          if (icon) {
            icon.className = "fas fa-video";
          }
        }
        if (scanFailureTimer) {
          clearTimeout(scanFailureTimer);
          scanFailureTimer = null;
        }
        setScannerError("");
        updateScannerState("inactive", message);
      }

      async function showLogin(message = "") {
        await stopCamera();
        state.currentRegistrationId = null;
        state.currentRecord = null;
        showBlock("login");
        setLoginLoading(false);
        setLoginError(message);
        setScannerError("");
        if (elements.logoutBtn) {
          elements.logoutBtn.classList.add("hidden");
          elements.logoutBtn.classList.remove("inline-flex");
        }
        if (elements.loginPasswordInput) {
          elements.loginPasswordInput.value = "";
          try {
            elements.loginPasswordInput.focus({ preventScroll: true });
          } catch (focusError) {
            elements.loginPasswordInput.focus();
          }
        }
        updateScannerState(
          "inactive",
          message || "Sign in to start scanning.",
        );
      }

      function createAuthError(message = "Authentication required") {
        const error = new Error(message);
        error.code = AUTH_REQUIRED_CODE;
        return error;
      }

      function clearAdminKey() {
        state.adminKey = null;
        if (typeof sessionStorage !== "undefined") {
          try {
            sessionStorage.removeItem(ADMIN_KEY_STORAGE_KEY);
          } catch (storageError) {
            console.warn("Unable to clear stored admin key", storageError);
          }
        }
      }

      async function ensureCameraPermission() {
        if (state.cameraPermissionGranted) {
          return;
        }
        if (!navigator.mediaDevices?.getUserMedia) {
          throw new Error("Camera access is not supported on this device.");
        }
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false,
        });
        stream.getTracks().forEach((track) => track.stop());
        state.cameraPermissionGranted = true;
      }

      function resetScanTimer() {
        if (scanFailureTimer) {
          clearTimeout(scanFailureTimer);
        }
        scanFailureTimer = setTimeout(() => {
          if (
            isCameraActive &&
            blocks.scanner &&
            !blocks.scanner.classList.contains("hidden")
          ) {
            showModal(modals.scanFailure);
          }
        }, SCAN_TIMEOUT_MS);
      }

      async function startCamera() {
        if (isCameraActive || !state.adminKey) {
          return;
        }
        updateScannerState("starting", "Initializing camera...");
        try {
          await loadHtml5Qrcode();
        } catch (loaderError) {
          console.error(loaderError);
          setScannerError(
            loaderError.message || "Unable to load QR scanner.",
          );
          updateScannerState(
            "inactive",
            loaderError.message || "Unable to load QR scanner.",
          );
          return;
        }
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("qr-reader");
        }
        try {
          const permissionState = await getCameraPermissionState();
          if (permissionState === "denied") {
            const blockedMessage =
              "Camera access is blocked in your browser settings. Enable it and retry.";
            showCameraPermissionError(blockedMessage);
            setScannerError(blockedMessage);
            return;
          }
          if (permissionState === "granted") {
            state.cameraPermissionGranted = true;
          }
        } catch (stateCheckError) {
          console.debug("Camera permission query failed", stateCheckError);
        }
        try {
          await ensureCameraPermission();
        } catch (permissionError) {
          console.error("Camera permission error:", permissionError);
          const guidance =
            permissionError?.message ||
            "Camera permission is required to scan codes.";
          showCameraPermissionError(guidance);
          setScannerError(guidance);
          return;
        }
        try {
          await html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1 },
            onScanSuccess,
            onScanFailure,
          );
          isCameraActive = true;
          setScannerError("");
          updateScannerState("active");
          if (elements.toggleCameraBtn) {
            const label = elements.toggleCameraBtn.querySelector("span");
            const icon = elements.toggleCameraBtn.querySelector("i");
            if (label) {
              label.textContent = "Turn Camera Off";
            }
            if (icon) {
              icon.className = "fas fa-video-slash";
            }
          }
          resetScanTimer();
        } catch (startError) {
          console.error("Camera start failed:", startError);
          // If browser explicitly denied camera permissions, show the permission UI
          try {
            const eName = startError && startError.name ? startError.name : "";
            if (eName === "NotAllowedError" || eName === "PermissionDeniedError") {
              const deniedMessage = "Camera access was denied by the browser.";
              showCameraPermissionError(deniedMessage);
              setScannerError(deniedMessage);
              return;
            }
          } catch (uiErr) {
            console.warn("Permission UI update failed:", uiErr);
          }
          setScannerError(
            "Unable to start the camera. Please allow permissions or try another device.",
          );
          updateScannerState(
            "inactive",
            "Unable to start the camera. Please allow permissions or try another device.",
          );
        }
      }

      async function authorizedFetch(url, options = {}) {
        if (!state.adminKey) {
          await showLogin("Please sign in to continue.");
          throw createAuthError();
        }
        const mergedHeaders = {
          ...(options.headers || {}),
          "x-admin-key": state.adminKey,
        };
        const requestOptions = {
          ...options,
          headers: mergedHeaders,
        };
        if (!requestOptions.cache) {
          requestOptions.cache = "no-store";
        }
        const response = await fetch(url, requestOptions);
        if (response.status === 401) {
          clearAdminKey();
          await showLogin("Session expired. Please sign in again.");
          throw createAuthError("Session expired. Please sign in again.");
        }
        return response;
      }

      function formatDateTime(value) {
        if (!value) {
          return "";
        }
        const date = new Date(value);
        return new Intl.DateTimeFormat("en-IN", {
          dateStyle: "medium",
          timeStyle: "short",
        }).format(date);
      }

      async function fetchRegistration(identifier) {
        let registrationId = null;
        let phone = null;

        if (typeof identifier === "string") {
          const trimmed = identifier.trim();
          if (trimmed) {
            registrationId = trimmed.toUpperCase();
          }
        } else if (identifier && typeof identifier === "object") {
          const regValue =
            identifier.registrationId ||
            identifier.registration_id ||
            identifier.id;
          const phoneValue =
            identifier.phone || identifier.mobile || identifier.contact;
          if (typeof regValue === "string") {
            const trimmedReg = regValue.trim();
            if (trimmedReg) {
              registrationId = trimmedReg.toUpperCase();
            }
          }
          if (
            typeof phoneValue === "string" ||
            typeof phoneValue === "number"
          ) {
            const phoneStr = String(phoneValue).trim();
            if (phoneStr) {
              phone = phoneStr;
            }
          }
        }

        if (!registrationId && !phone) {
          return null;
        }

        const searchParams = new URLSearchParams();
        if (registrationId) {
          searchParams.set("registrationId", registrationId);
        }
        if (phone) {
          searchParams.set("phone", phone);
        }

        const response = await authorizedFetch(
          `/.netlify/functions/search-user?${searchParams.toString()}`,
          { method: "GET" },
        );
        if (response.status === 404) {
          return null;
        }
        if (!response.ok) {
          const { error } = await response
            .json()
            .catch(() => ({ error: "Unexpected error occurred." }));
          throw new Error(error || "Unable to look up registration.");
        }
        const data = await response.json();
        return Array.isArray(data) ? data[0] : data;
      }

      function deriveLookupParams(decodedText) {
        if (!decodedText) {
          return null;
        }
        const trimmed = decodedText.trim();
        if (!trimmed) {
          return null;
        }
        try {
          const parsed = JSON.parse(trimmed);
          if (parsed && typeof parsed === "object") {
            const registrationId =
              parsed.registrationId || parsed.registration_id || parsed.id;
            const phone = parsed.phone || parsed.mobile || parsed.contact;
            if (registrationId || phone) {
              return { registrationId, phone };
            }
          }
        } catch (parseError) {
          // Not JSON; fall back to treating the entire string as a registration ID
        }
        return { registrationId: trimmed };
      }

      function populateResult(record) {
        const placeholder =
          "https://cdn.jsdelivr.net/gh/ellowdigital/assets@main/images/avatar-placeholder.png";
        elements.resultPhoto.src = record.image_url || placeholder;
        elements.resultName.textContent = record.name || "Unnamed Attendee";
        elements.resultRegId.textContent = record.registration_id;
        elements.resultPassType.textContent = record.payment_id
          ? "Paid Registration"
          : "Standard Pass";
        elements.resultStatus.textContent = record.checked_in_at
          ? `Checked In • ${formatDateTime(record.checked_in_at)}`
          : "Not Checked In";
        state.currentRegistrationId = record.registration_id;
        state.currentRecord = record;
      }

      async function onScanSuccess(decodedText) {
        if (!decodedText) {
          return;
        }
        playScanSuccessSound();
        if (scanFailureTimer) {
          clearTimeout(scanFailureTimer);
        }
        await stopCamera();
        try {
          const lookupParams = deriveLookupParams(decodedText);
          if (!lookupParams) {
            alert("Scanned code did not contain recognizable information.");
            await resetToScanner();
            return;
          }
          const record = await fetchRegistration(lookupParams);
          if (!record) {
            showNotFound();
            await resetToScanner();
            return;
          }
          populateResult(record);
          showBlock("result");
        } catch (error) {
          if (error.code === AUTH_REQUIRED_CODE) {
            return;
          }
          console.error("Lookup failed:", error);
          alert(error.message || "Unable to verify the pass.");
          await resetToScanner();
        }
      }

      function onScanFailure() {
        // keep timer running silently
      }

      function showNotFound() {
        if (!elements.notFoundIcon) {
          return;
        }
        elements.notFoundIcon.classList.remove("shake");
        void elements.notFoundIcon.offsetWidth;
        elements.notFoundIcon.classList.add("shake");
        showModal(modals.notFound);
      }

      async function performManualSearch() {
        if (!elements.manualInput) {
          return;
        }
        const inputValue = elements.manualInput.value.trim();
        if (!inputValue) {
          elements.manualInput.focus();
          return;
        }
        await stopCamera("Camera is off while you verify manually.");
        try {
          const record = await fetchRegistration(inputValue);
          if (!record) {
            showNotFound();
            return;
          }
          populateResult(record);
          showBlock("result");
        } catch (error) {
          if (error.code === AUTH_REQUIRED_CODE) {
            return;
          }
          alert(error.message || "Unable to verify the pass.");
        }
      }

      async function markRegistrationCheckedIn() {
        if (!state.currentRegistrationId) {
          return;
        }
        const response = await authorizedFetch(
          "/.netlify/functions/mark-checked-in",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              registrationId: state.currentRegistrationId,
            }),
          },
        );
        if (!response.ok) {
          const { error } = await response
            .json()
            .catch(() => ({ error: "Unable to mark check-in." }));
          throw new Error(error || "Unable to mark check-in.");
        }
        const result = await response.json();
        if (result?.data?.checked_in_at) {
          state.currentRecord.checked_in_at = result.data.checked_in_at;
          elements.resultStatus.textContent = `Checked In • ${formatDateTime(result.data.checked_in_at)}`;
        }
        return result;
      }

      async function resetToScanner() {
        if (!state.adminKey) {
          await showLogin();
          return;
        }
        showBlock("scanner");
        if (elements.manualInput) {
          elements.manualInput.value = "";
        }
        state.currentRegistrationId = null;
        state.currentRecord = null;
        setScannerError("");
        updateScannerState("starting", "Initializing camera...");
        await startCamera();
      }

      function handleScanFailureModalClose() {
        hideModal(modals.scanFailure);
        resetScanTimer();
      }

      if (elements.toggleCameraBtn) {
        elements.toggleCameraBtn.addEventListener("click", async () => {
          if (!state.adminKey) {
            await showLogin();
            return;
          }
          if (isCameraActive) {
            await stopCamera(
              "Camera is off. Tap Turn Camera On to resume scanning.",
            );
          } else {
            await startCamera();
          }
        });
      }

      if (elements.manualTriggerBtn) {
        elements.manualTriggerBtn.addEventListener("click", async () => {
          if (!state.adminKey) {
            await showLogin();
            return;
          }
          await stopCamera("Camera is off while you verify manually.");
          showBlock("manual");
          if (elements.manualInput) {
            elements.manualInput.focus();
          }
          setScannerError("");
        });
      }

      if (elements.manualSearchBtn) {
        elements.manualSearchBtn.addEventListener(
          "click",
          performManualSearch,
        );
      }

      if (elements.manualInput) {
        elements.manualInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            performManualSearch();
          }
        });
      }

      if (elements.backToScannerBtn) {
        elements.backToScannerBtn.addEventListener("click", resetToScanner);
      }

      if (elements.keepScanningBtn) {
        elements.keepScanningBtn.addEventListener(
          "click",
          handleScanFailureModalClose,
        );
      }

      if (elements.switchManualBtn) {
        elements.switchManualBtn.addEventListener("click", async () => {
          hideModal(modals.scanFailure);
          await stopCamera("Camera is off while you verify manually.");
          showBlock("manual");
          if (elements.manualInput) {
            elements.manualInput.focus();
          }
          setScannerError("");
        });
      }

      if (elements.notFoundCloseBtn) {
        elements.notFoundCloseBtn.addEventListener("click", () => {
          hideModal(modals.notFound);
          if (
            blocks.manual &&
            blocks.manual.classList.contains("hidden") &&
            state.adminKey
          ) {
            resetScanTimer();
          }
        });
      }

      if (elements.newScanBtn) {
        elements.newScanBtn.addEventListener("click", resetToScanner);
      }

      if (elements.checkedInBtn) {
        elements.checkedInBtn.addEventListener("click", async () => {
          if (!state.currentRegistrationId) {
            return;
          }
          elements.checkedInBtn.disabled = true;
          try {
            await markRegistrationCheckedIn();
            playCheckInSound();
            if (typeof confetti === "function") {
              confetti({
                particleCount: 120,
                spread: 70,
                origin: { y: 0.6 },
              });
            }
            await new Promise((resolve) => setTimeout(resolve, 700));
            await resetToScanner();
          } catch (error) {
            if (error.code !== AUTH_REQUIRED_CODE) {
              alert(error.message || "Could not mark check-in.");
            }
          } finally {
            elements.checkedInBtn.disabled = false;
          }
        });
      }

      elements.loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const password = elements.loginPasswordInput.value.trim();
        if (!password) {
          setLoginError("Please enter the admin password.");
          elements.loginPasswordInput.focus();
          return;
        }
        setLoginError("");
        setLoginLoading(true);
        try {
          const response = await fetch("/.netlify/functions/admin-login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password }),
            cache: "no-store",
          });
          if (!response.ok) {
            throw new Error("Incorrect password. Please try again.");
          }
          const data = await response.json();
          if (!data?.secretKey) {
            throw new Error("Unexpected response from server.");
          }
          state.adminKey = data.secretKey;
          setLoginError("");
          showBlock("scanner");
          if (elements.logoutBtn) {
            elements.logoutBtn.classList.remove("hidden");
            elements.logoutBtn.classList.add("inline-flex");
          }
          elements.loginPasswordInput.value = "";
          updateScannerState("starting", "Initializing camera...");
          await startCamera();
        } catch (error) {
          setLoginError(
            error.message || "Unable to sign in. Please try again.",
          );
          if (
            elements.loginPasswordInput &&
            typeof elements.loginPasswordInput.select === "function"
          ) {
            elements.loginPasswordInput.select();
          }
        } finally {
          setLoginLoading(false);
        }
      });

      if (elements.logoutBtn) {
        elements.logoutBtn.addEventListener("click", async () => {
          elements.logoutBtn.disabled = true;
          try {
            await stopCamera();
            clearAdminKey();
            await showLogin("Signed out successfully.");
          } finally {
            elements.logoutBtn.disabled = false;
          }
        });
      }

      window.addEventListener("load", async () => {
        if (state.adminKey) {
          showBlock("scanner");
          if (elements.logoutBtn) {
            elements.logoutBtn.classList.remove("hidden");
            elements.logoutBtn.classList.add("inline-flex");
          }
          updateScannerState("starting", "Initializing camera...");
          await startCamera();
        } else {
          await showLogin();
        }
      });

      // Retry permission button (reloads the page to re-prompt permissions)
      const reloadPermissionBtn = document.getElementById("reloadPermissionBtn");
      if (reloadPermissionBtn) {
        reloadPermissionBtn.addEventListener("click", () => {
          try {
            location.reload();
          } catch (err) {
            // Fallback for older browsers
            window.location.href = window.location.href;
          }
        });
      }

      window.addEventListener("beforeunload", () => {
        if (scanFailureTimer) {
          clearTimeout(scanFailureTimer);
        }
      });
    })();
  </script>
</body>

</html>